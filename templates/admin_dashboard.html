{% extends 'base.html' %}
{% block content %}

<script>
  window.__users = [
    {% for u in users %}
    {
      id: {{ u.id }},
      name: {{ u.name|tojson }},
      email: {{ u.email|tojson }},
      avatar: {{ url_for('serve_file', filename=u.avatar.filename)|tojson if u.avatar else 'null' }},
      is_trainer: {{ 'true' if u.is_trainer else 'false' }},
      has_subscription: {{ 'true' if u.has_subscription else 'false' }},
      is_verified: {{ 'true' if u.is_verified else 'false' }},
      current_streak: {{ u.current_streak|default(0) }},
      squad_status: {{ u.squad_status|tojson|default('none') }},
      owns_group: {{ 'true' if statuses.get(u.id, {}).get('owns_group') else 'false' }},
      meal_today: {{ 'true' if statuses.get(u.id, {}).get('meal') else 'false' }},
      activity_today: {{ 'true' if statuses.get(u.id, {}).get('activity') else 'false' }}
    }{{ '' if loop.last else ',' }}
    {% endfor %}
  ];
  window.__details = {{ details|tojson }};
  window.__urls = {
    detail: "{{ url_for('admin_user_detail', user_id=0) }}".replace(/0$/, ""),
    admin_applications_list: "{{ url_for('admin_applications_list') }}",
    delete: "{{ url_for('admin_delete_user', user_id=0) }}".replace(/0$/, ""),
    magic: "{{ url_for('admin_send_magic_link', user_id=0) }}".replace(/0$/, ""),
    create: "{{ url_for('admin_create_user') }}",
    groups: "{{ url_for('admin_groups_list') }}",
    squads_dist: "{{ url_for('admin_squads_distribution') }}",
    squads_list: "{{ url_for('admin_squads_control') }}",
    squad_create: "{{ url_for('admin_create_squad') }}",
    notify_send: "{{ url_for('admin_users_notify') }}",
    aiq: "{{ url_for('admin_ai_queue') }}",
    jobs: "{{ url_for('admin_jobs') }}",
    prompts: "{{ url_for('admin_prompts') }}",
    broadcast: "{{ url_for('admin_broadcast') }}",
    audit: "{{ url_for('admin_audit') }}",
    reports: "{{ url_for('admin_reports') }}",
    analytics: "{{ url_for('admin_analytics_page') }}",
    recipes: "{{ url_for('admin_recipes_page') }}",
    support: "{{ url_for('admin_support_page') }}"
  };
</script>

<div class="max-w-7xl mx-auto px-4 py-8" x-data="adminPage()">

  <div class="flex flex-col md:flex-row md:items-center justify-between gap-4 mb-8">
    <div>
        <h1 class="text-3xl font-bold text-gray-900">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</h1>
        <p class="text-sm text-gray-500 mt-1">
            –í—Å–µ–≥–æ: <span x-text="rows.length" class="font-medium text-gray-900"></span> |
            –§–∏–ª—å—Ç—Ä: <span x-text="filtered.length" class="font-medium text-indigo-600"></span>
        </p>
    </div>

    <div class="flex flex-wrap gap-2">
        <a :href="urls.create" class="inline-flex items-center gap-2 px-4 py-2 bg-white border border-gray-300 text-gray-700 text-sm font-medium rounded-lg hover:bg-gray-50 shadow-sm transition">
            ‚ûï –Æ–∑–µ—Ä
        </a>
        <a :href="urls.admin_applications_list" class="inline-flex items-center gap-2 px-4 py-2 bg-white border border-gray-300 text-gray-700 text-sm font-medium rounded-lg hover:bg-gray-50 shadow-sm transition">
            üìù –ó–∞—è–≤–∫–∏
        </a>

        <div class="h-8 w-px bg-gray-300 mx-1"></div>

        <button @click="squadModalOpen = true" class="inline-flex items-center gap-2 px-4 py-2 bg-orange-600 text-white text-sm font-medium rounded-lg hover:bg-orange-700 shadow-sm transition">
            üõ°Ô∏è –°–æ–∑–¥–∞—Ç—å –û—Ç—Ä—è–¥
        </button>
        <a :href="urls.squads_list" class="inline-flex items-center gap-2 px-4 py-2 bg-slate-800 text-white text-sm font-medium rounded-lg hover:bg-slate-900 shadow-sm transition">
            üë• –í—Å–µ –û—Ç—Ä—è–¥—ã
        </a>
    </div>
  </div>

  <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-3 mb-6">
      <a :href="urls.analytics" class="flex flex-col items-center justify-center p-3 bg-white border rounded-lg hover:border-indigo-300 hover:shadow-md transition group">
          <span class="text-2xl group-hover:scale-110 transition">üìà</span>
          <span class="text-xs font-medium text-gray-600 mt-1">–ê–Ω–∞–ª–∏—Ç–∏–∫–∞</span>
      </a>
      <a :href="urls.squads_dist" class="flex flex-col items-center justify-center p-3 bg-white border rounded-lg hover:border-indigo-300 hover:shadow-md transition group">
          <span class="text-2xl group-hover:scale-110 transition">‚öîÔ∏è</span>
          <span class="text-xs font-medium text-gray-600 mt-1">–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ</span>
      </a>
      <a :href="urls.aiq" class="flex flex-col items-center justify-center p-3 bg-white border rounded-lg hover:border-indigo-300 hover:shadow-md transition group">
          <span class="text-2xl group-hover:scale-110 transition">ü§ñ</span>
          <span class="text-xs font-medium text-gray-600 mt-1">AI –û—á–µ—Ä–µ–¥—å</span>
      </a>
      <a :href="urls.support" class="flex flex-col items-center justify-center p-3 bg-white border rounded-lg hover:border-indigo-300 hover:shadow-md transition group">
          <span class="text-2xl group-hover:scale-110 transition">üí¨</span>
          <span class="text-xs font-medium text-gray-600 mt-1">–ü–æ–¥–¥–µ—Ä–∂–∫–∞</span>
      </a>
      <a :href="urls.jobs" class="flex flex-col items-center justify-center p-3 bg-white border rounded-lg hover:border-indigo-300 hover:shadow-md transition group">
          <span class="text-2xl group-hover:scale-110 transition">‚è±</span>
          <span class="text-xs font-medium text-gray-600 mt-1">Cron Jobs</span>
      </a>
      <a :href="urls.broadcast" class="flex flex-col items-center justify-center p-3 bg-white border rounded-lg hover:border-indigo-300 hover:shadow-md transition group">
          <span class="text-2xl group-hover:scale-110 transition">üì£</span>
          <span class="text-xs font-medium text-gray-600 mt-1">–†–∞—Å—Å—ã–ª–∫–∞</span>
      </a>
  </div>

  <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-4 mb-6">
    <div class="grid grid-cols-1 md:grid-cols-12 gap-4">
      <div class="md:col-span-4">
        <label class="block text-xs font-semibold text-gray-500 uppercase tracking-wider mb-1">–ü–æ–∏—Å–∫</label>
        <div class="relative">
            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                <svg class="h-4 w-4 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/></svg>
            </div>
            <input x-model.debounce.250ms="q" type="text" class="block w-full pl-10 sm:text-sm border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500" placeholder="–ò–º—è, email –∏–ª–∏ ID">
        </div>
      </div>

      <div class="md:col-span-2">
        <label class="block text-xs font-semibold text-gray-500 uppercase tracking-wider mb-1">–ü–æ–¥–ø–∏—Å–∫–∞</label>
        <select x-model="filters.sub" class="block w-full sm:text-sm border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
          <option value="any">–í—Å–µ</option>
          <option value="active">–¢–æ–ª—å–∫–æ –∞–∫—Ç–∏–≤–Ω—ã–µ</option>
          <option value="none">–ë–µ–∑ –ø–æ–¥–ø–∏—Å–∫–∏</option>
        </select>
      </div>

      <div class="md:col-span-2">
        <label class="block text-xs font-semibold text-gray-500 uppercase tracking-wider mb-1">–†–æ–ª—å</label>
        <select x-model="filters.trainer" class="block w-full sm:text-sm border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
          <option value="any">–í—Å–µ</option>
          <option value="yes">–¢—Ä–µ–Ω–µ—Ä—ã</option>
          <option value="no">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</option>
        </select>
      </div>

      <div class="md:col-span-2">
        <label class="block text-xs font-semibold text-gray-500 uppercase tracking-wider mb-1">–°–µ–≥–æ–¥–Ω—è</label>
        <select x-model="filters.activity" class="block w-full sm:text-sm border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
          <option value="any">–ù–µ –≤–∞–∂–Ω–æ</option>
          <option value="ok">–ê–∫—Ç–∏–≤–Ω—ã–µ (–ï–¥–∞/–®–∞–≥–∏)</option>
          <option value="no">–ù–µ–∞–∫—Ç–∏–≤–Ω—ã–µ</option>
        </select>
      </div>

      <div class="md:col-span-2 flex items-end">
          <button @click="q=''; filters={sub:'any', trainer:'any', activity:'any'};" class="w-full px-4 py-2 border border-gray-300 shadow-sm text-sm font-medium rounded-lg text-gray-700 bg-white hover:bg-gray-50">
              –°–±—Ä–æ—Å–∏—Ç—å
          </button>
      </div>
    </div>

    <div class="mt-4 pt-4 border-t border-gray-100 flex flex-wrap items-center gap-3" x-show="selected.size > 0" x-transition>
        <span class="text-sm font-medium text-indigo-600 bg-indigo-50 px-2 py-1 rounded">–í—ã–±—Ä–∞–Ω–æ: <span x-text="selected.size"></span></span>

        <button @click="notifyModalOpen = true" class="text-sm text-white bg-indigo-600 hover:bg-indigo-700 px-3 py-1.5 rounded-lg flex items-center gap-1 shadow-sm transition">
            üîî –û—Ç–ø—Ä–∞–≤–∏—Ç—å PUSH
        </button>

        <div class="h-4 w-px bg-gray-300"></div>

        <button @click="copyEmails()" class="text-sm text-gray-600 hover:text-indigo-600 flex items-center gap-1">
            üìã –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å Email
        </button>
        <button @click="exportCSV()" class="text-sm text-gray-600 hover:text-indigo-600 flex items-center gap-1">
            ‚¨á CSV –≠–∫—Å–ø–æ—Ä—Ç
        </button>
        <button @click="clearSelection()" class="text-sm text-red-500 hover:text-red-700 ml-auto">
            –û—Ç–º–µ–Ω–∞
        </button>
    </div>
  </div>

  <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
    <div class="overflow-x-auto">
      <table class="min-w-full divide-y divide-gray-200">
        <thead class="bg-gray-50">
          <tr>
            <th scope="col" class="px-4 py-3 w-10">
              <input type="checkbox" class="rounded border-gray-300 text-indigo-600 focus:ring-indigo-500" :checked="allOnPageSelected" @change="toggleSelectAllOnPage($event)">
            </th>
            <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer group" @click="toggleSort('name')">
              –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å <span class="text-gray-300 group-hover:text-gray-500" x-text="sortIcon('name')"></span>
            </th>
            <th scope="col" class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer group" @click="toggleSort('has_subscription')">
              –°—Ç–∞—Ç—É—Å <span class="text-gray-300 group-hover:text-gray-500" x-text="sortIcon('has_subscription')"></span>
            </th>
            <th scope="col" class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">
              –°–µ–≥–æ–¥–Ω—è
            </th>
            <th scope="col" class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer group" @click="toggleSort('current_streak')">
              –ò–Ω—Ñ–æ <span class="text-gray-300 group-hover:text-gray-500" x-text="sortIcon('current_streak')"></span>
            </th>
            <th scope="col" class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">
              –î–µ–π—Å—Ç–≤–∏—è
            </th>
          </tr>
        </thead>
        <tbody class="divide-y divide-gray-200 bg-white">
          <template x-for="row in pageRows" :key="row.id">
            <template x-if="true"> <React.Fragment> <tr class="hover:bg-gray-50 transition-colors" :class="{'bg-indigo-50/50': expanded === row.id}">
              <td class="px-4 py-4 whitespace-nowrap">
                <input type="checkbox" class="rounded border-gray-300 text-indigo-600 focus:ring-indigo-500" :checked="isSelected(row.id)" @change="toggleSelect(row.id)">
              </td>

              <td class="px-4 py-4 whitespace-nowrap">
                <div class="flex items-center">
                  <div class="flex-shrink-0 h-10 w-10">
                    <template x-if="row.avatar">
                        <img class="h-10 w-10 rounded-full object-cover border border-gray-200" :src="row.avatar" alt="">
                    </template>
                    <template x-if="!row.avatar">
                        <div class="h-10 w-10 rounded-full bg-gray-100 flex items-center justify-center text-gray-500 font-bold text-sm" x-text="row.name.charAt(0)"></div>
                    </template>
                  </div>
                  <div class="ml-4">
                    <div class="text-sm font-medium text-gray-900 flex items-center gap-1">
                        <a :href="urls.detail + row.id" class="hover:text-indigo-600 hover:underline" x-text="row.name"></a>
                        <template x-if="row.is_verified">
                            <span title="Email –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω" class="text-blue-500">
                                <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M6.267 3.455a3.066 3.066 0 001.745-.723 3.066 3.066 0 013.976 0 3.066 3.066 0 001.745.723 3.066 3.066 0 012.812 2.812c.051.643.304 1.254.723 1.745a3.066 3.066 0 010 3.976 3.066 3.066 0 00-.723 1.745 3.066 3.066 0 01-2.812 2.812 3.066 3.066 0 00-1.745.723 3.066 3.066 0 01-3.976 0 3.066 3.066 0 00-1.745-.723 3.066 3.066 0 01-2.812-2.812 3.066 3.066 0 00-.723-1.745 3.066 3.066 0 010-3.976 3.066 3.066 0 00.723-1.745 3.066 3.066 0 012.812-2.812zm7.44 5.252a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/></svg>
                            </span>
                        </template>
                    </div>
                    <div class="text-sm text-gray-500" x-text="row.email"></div>
                  </div>
                </div>
              </td>

              <td class="px-4 py-4 whitespace-nowrap text-center">
                <div class="flex flex-col items-center gap-1">
                    <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full"
                        :class="row.has_subscription ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'"
                        x-text="row.has_subscription ? 'Premium' : 'Free'">
                    </span>
                    <template x-if="row.is_trainer">
                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-indigo-100 text-indigo-800">
                            –¢—Ä–µ–Ω–µ—Ä
                        </span>
                    </template>
                </div>
              </td>

              <td class="px-4 py-4 whitespace-nowrap text-center">
                  <div class="flex justify-center gap-2">
                      <span class="flex items-center gap-1 px-2 py-1 rounded text-xs border"
                            :class="row.meal_today ? 'bg-green-50 border-green-200 text-green-700' : 'bg-gray-50 border-gray-200 text-gray-400 opacity-50'">
                          <span>ü•ó</span>
                          <span x-text="row.meal_today ? '–î–∞' : ''"></span>
                      </span>
                      <span class="flex items-center gap-1 px-2 py-1 rounded text-xs border"
                            :class="row.activity_today ? 'bg-blue-50 border-blue-200 text-blue-700' : 'bg-gray-50 border-gray-200 text-gray-400 opacity-50'">
                          <span>üë£</span>
                          <span x-text="row.activity_today ? '–î–∞' : ''"></span>
                      </span>
                  </div>
              </td>

              <td class="px-4 py-4 whitespace-nowrap text-center">
                  <div class="text-sm text-gray-900 font-medium">
                      <span x-show="row.current_streak > 0">üî• <span x-text="row.current_streak"></span> –¥–Ω.</span>
                      <span x-show="row.current_streak === 0" class="text-gray-400">‚Äî</span>
                  </div>
                  <div class="text-xs text-gray-500 mt-0.5">
                      <span x-show="row.squad_status !== 'none'">Squad: <span x-text="row.squad_status"></span></span>
                  </div>
              </td>

              <td class="px-4 py-4 whitespace-nowrap text-right text-sm font-medium">
                <div class="flex justify-end items-center gap-2">
                    <button @click="sendMagic(row.id)" title="–û—Ç–ø—Ä–∞–≤–∏—Ç—å —Å—Å—ã–ª–∫—É –¥–ª—è –≤—Ö–æ–¥–∞" class="text-gray-400 hover:text-indigo-600 transition">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 7a2 2 0 012 2m4 0a6 6 0 01-7.743 5.743L11.536 19.464a6 6 0 01-1.414 0l-.707-.707a1 1 0 010-1.414l.707-.707a1 1 0 011.414 0L13.172 15.172a4 4 0 015.656-5.656zM9 10a.5.5 0 010-1h1v1H9zm1-2a.5.5 0 01.5-.5h.5v.5H10V8zm3 1a.5.5 0 01-.5.5h-.5v-.5H13V9z"/></svg>
                    </button>
                    <a :href="urls.detail + row.id" title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å / –î–µ—Ç–∞–ª–∏" class="text-gray-400 hover:text-blue-600 transition">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/></svg>
                    </a>
                    <button @click="toggleExpand(row.id)" title="–ë—ã—Å—Ç—Ä—ã–π –ø—Ä–æ—Å–º–æ—Ç—Ä" class="text-gray-400 hover:text-gray-700 transition">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" :class="{'rotate-180': expanded === row.id}"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg>
                    </button>
                </div>
              </td>
            </tr>

            <tr x-show="expanded === row.id" x-cloak class="bg-gray-50 border-b border-gray-200">
                <td colspan="6" class="px-4 py-6">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6" x-data="{ d: getDetail(row.id) }">

                        <div class="col-span-1 bg-white p-4 rounded-lg shadow-sm border border-gray-100">
                            <h4 class="text-xs font-semibold text-gray-500 uppercase tracking-wider mb-3">–ü–∏—Ç–∞–Ω–∏–µ —Å–µ–≥–æ–¥–Ω—è</h4>
                            <template x-if="(d.meals||[]).length">
                                <div class="space-y-2">
                                    <template x-for="m in d.meals" :key="m.type">
                                        <div class="flex justify-between items-center text-sm">
                                            <span class="capitalize text-gray-700 font-medium" x-text="m.type"></span>
                                            <span class="bg-gray-100 px-2 py-0.5 rounded text-gray-600" x-text="m.cal + ' –∫–∫–∞–ª'"></span>
                                        </div>
                                    </template>
                                </div>
                            </template>
                            <template x-if="!(d.meals||[]).length">
                                <p class="text-sm text-gray-400 italic">–ù–µ—Ç –∑–∞–ø–∏—Å–µ–π</p>
                            </template>
                        </div>

                        <div class="col-span-1 bg-white p-4 rounded-lg shadow-sm border border-gray-100">
                            <h4 class="text-xs font-semibold text-gray-500 uppercase tracking-wider mb-3">–ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å</h4>
                            <template x-if="d.activity && d.activity.steps !== null">
                                <div class="grid grid-cols-2 gap-4 text-center">
                                    <div>
                                        <div class="text-xl font-bold text-gray-800" x-text="d.activity.steps"></div>
                                        <div class="text-xs text-gray-500">–®–∞–≥–∏</div>
                                    </div>
                                    <div>
                                        <div class="text-xl font-bold text-gray-800" x-text="d.activity.active_kcal"></div>
                                        <div class="text-xs text-gray-500">–ö–∫–∞–ª</div>
                                    </div>
                                </div>
                            </template>
                            <template x-if="!d.activity || d.activity.steps === null">
                                <p class="text-sm text-gray-400 italic">–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏</p>
                            </template>
                        </div>

                        <div class="col-span-1 bg-white p-4 rounded-lg shadow-sm border border-gray-100">
                            <h4 class="text-xs font-semibold text-gray-500 uppercase tracking-wider mb-3">–ü–æ—Å–ª–µ–¥–Ω–∏–π –∑–∞–º–µ—Ä</h4>
                            <template x-if="(d.metrics||[]).length">
                                <div class="flex flex-wrap gap-2">
                                    <template x-for="m in d.metrics" :key="m.label">
                                        <div class="bg-gray-50 px-2 py-1 rounded text-xs text-gray-700 border border-gray-200">
                                            <span x-text="m.label"></span>: <span class="font-bold" x-text="m.cur"></span>
                                        </div>
                                    </template>
                                </div>
                            </template>
                            <template x-if="!(d.metrics||[]).length">
                                <p class="text-sm text-gray-400 italic">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</p>
                            </template>
                        </div>

                    </div>

                    <div class="mt-4 flex justify-end">
                        <button @click="deleteUser(row.id, row.name)" class="text-xs text-red-500 hover:text-red-700 hover:underline">
                            –£–¥–∞–ª–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                        </button>
                    </div>
                </td>
            </tr>
            </React.Fragment>
            </template>
          </template>

          <tr x-show="!pageRows.length">
            <td colspan="6" class="px-6 py-10 text-center text-gray-500">
                <div class="flex flex-col items-center">
                    <span class="text-3xl mb-2">üîç</span>
                    <span>–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</span>
                </div>
            </td>
          </tr>
        </tbody>
      </table>
    </div>

    <div class="px-4 py-3 border-t border-gray-200 bg-gray-50 flex items-center justify-between sm:px-6">
        <div class="hidden sm:flex-1 sm:flex sm:items-center sm:justify-between">
            <div>
                <p class="text-sm text-gray-700">
                    –ü–æ–∫–∞–∑–∞–Ω–æ <span class="font-medium" x-text="pageStart + 1"></span> - <span class="font-medium" x-text="Math.min(pageEnd, filtered.length)"></span> –∏–∑ <span class="font-medium" x-text="filtered.length"></span>
                </p>
            </div>
            <div>
                <nav class="relative z-0 inline-flex rounded-md shadow-sm -space-x-px" aria-label="Pagination">
                    <button @click="page=1" :disabled="page===1" class="relative inline-flex items-center px-2 py-2 rounded-l-md border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-50 disabled:opacity-50">
                        &laquo;
                    </button>
                    <button @click="page--" :disabled="page===1" class="relative inline-flex items-center px-4 py-2 border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-50 disabled:opacity-50">
                        –ù–∞–∑–∞–¥
                    </button>
                    <button @click="page++" :disabled="page===pageCount" class="relative inline-flex items-center px-4 py-2 border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-50 disabled:opacity-50">
                        –í–ø–µ—Ä–µ–¥
                    </button>
                    <button @click="page=pageCount" :disabled="page===pageCount" class="relative inline-flex items-center px-2 py-2 rounded-r-md border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-50 disabled:opacity-50">
                        &raquo;
                    </button>
                </nav>
            </div>
        </div>
    </div>
  </div>

  <div x-show="squadModalOpen" x-cloak class="fixed inset-0 z-50 overflow-y-auto">
    <div class="flex items-end justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
        <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity" @click="squadModalOpen = false"></div>
        <span class="hidden sm:inline-block sm:align-middle sm:h-screen">&#8203;</span>

        <div class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full">
            <form :action="urls.squad_create" method="POST">
                <div class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                    <h3 class="text-lg leading-6 font-medium text-gray-900 mb-4">–°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –û—Ç—Ä—è–¥–∞</h3>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700">–ù–∞–∑–≤–∞–Ω–∏–µ</label>
                            <input type="text" name="name" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:ring-orange-500 focus:border-orange-500 sm:text-sm">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">–û–ø–∏—Å–∞–Ω–∏–µ</label>
                            <textarea name="description" rows="2" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:ring-orange-500 focus:border-orange-500 sm:text-sm"></textarea>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">–ù–∞–∑–Ω–∞—á–∏—Ç—å —Ç—Ä–µ–Ω–µ—Ä–∞</label>
                            <select name="trainer_id" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:ring-orange-500 focus:border-orange-500 sm:text-sm">
                                <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è...</option>
                                <template x-for="u in rows" :key="u.id">
                                    <option :value="u.id"
                                            :disabled="u.owns_group"
                                            x-text="u.name + (u.owns_group ? ' (–£–∂–µ –∑–∞–Ω—è—Ç)' : (u.is_trainer ? ' (–¢—Ä–µ–Ω–µ—Ä)' : ''))">
                                    </option>
                                </template>
                            </select>
                        </div>
                    </div>
                </div>
                <div class="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
                    <button type="submit" class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-orange-600 text-base font-medium text-white hover:bg-orange-700 focus:outline-none sm:ml-3 sm:w-auto sm:text-sm">
                        –°–æ–∑–¥–∞—Ç—å
                    </button>
                    <button type="button" @click="squadModalOpen = false" class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none sm:mt-0 sm:ml-3 sm:w-auto sm:text-sm">
                        –û—Ç–º–µ–Ω–∞
                    </button>
                </div>
            </form>
        </div>
    </div>
  </div>

  <div x-show="notifyModalOpen" x-cloak class="fixed inset-0 z-50 overflow-y-auto">
    <div class="flex items-end justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
        <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity" @click="notifyModalOpen = false"></div>
        <span class="hidden sm:inline-block sm:align-middle sm:h-screen">&#8203;</span>

        <div class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full">
            <div class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                <h3 class="text-lg leading-6 font-medium text-gray-900 mb-2">–û—Ç–ø—Ä–∞–≤–∏—Ç—å PUSH —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ</h3>
                <p class="text-sm text-gray-500 mb-4">–í—ã–±—Ä–∞–Ω–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π: <span x-text="selected.size"></span></p>

                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700">–ó–∞–≥–æ–ª–æ–≤–æ–∫</label>
                        <input type="text" x-model="notifTitle" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">–¢–µ–∫—Å—Ç</label>
                        <textarea x-model="notifBody" rows="3" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"></textarea>
                    </div>
                </div>
            </div>
            <div class="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
                <button @click="sendNotification()" class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-indigo-600 text-base font-medium text-white hover:bg-indigo-700 focus:outline-none sm:ml-3 sm:w-auto sm:text-sm">
                    –û—Ç–ø—Ä–∞–≤–∏—Ç—å
                </button>
                <button @click="notifyModalOpen = false" class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none sm:mt-0 sm:ml-3 sm:w-auto sm:text-sm">
                    –û—Ç–º–µ–Ω–∞
                </button>
            </div>
        </div>
    </div>
  </div>

</div>

<script>
function adminPage(){
  return {
    rows: window.__users || [],
    details: window.__details || {},
    urls: window.__urls || {},
    q: '',
    filters: { sub: 'any', trainer: 'any', activity: 'any' },
    sortKey: 'id',
    sortDir: 'desc',
    page: 1,
    pageSize: 20,
    selected: new Set(),
    expanded: null,
    squadModalOpen: false,
    notifyModalOpen: false,
    notifTitle: '',
    notifBody: '',

    norm(s){ return (s||'').toString().toLowerCase().trim(); },
    isSelected(id){ return this.selected.has(id); },
    toggleSelect(id){ this.selected.has(id) ? this.selected.delete(id) : this.selected.add(id); },
    clearSelection(){ this.selected.clear(); },
    toggleSelectAllOnPage(e){
      const check = e.target.checked;
      this.pageRows.forEach(r => check ? this.selected.add(r.id) : this.selected.delete(r.id));
    },
    get allOnPageSelected(){
      if(!this.pageRows.length) return false;
      return this.pageRows.every(r => this.selected.has(r.id));
    },
    sortIcon(key){
      if(this.sortKey!==key) return '‚Üï';
      return this.sortDir==='asc' ? '‚ñ≤' : '‚ñº';
    },
    toggleSort(key){
      if(this.sortKey===key){ this.sortDir = this.sortDir==='asc' ? 'desc' : 'asc'; }
      else { this.sortKey = key; this.sortDir = 'asc'; }
    },
    toggleExpand(id){ this.expanded = (this.expanded===id ? null : id); },
    getDetail(id){
      return this.details[id] || this.details[String(id)] || { meals: [], activity: null, metrics: [] };
    },

    passesFilters(r){
      if(this.filters.sub !== 'any'){
        const need = this.filters.sub === 'active';
        if(r.has_subscription !== need) return false;
      }
      if(this.filters.trainer !== 'any'){
        const need = this.filters.trainer === 'yes';
        if(r.is_trainer !== need) return false;
      }
      if(this.filters.activity !== 'any'){
        const hasSome = r.meal_today || r.activity_today;
        if(this.filters.activity === 'ok' && !hasSome) return false;
        if(this.filters.activity === 'no' && hasSome) return false;
      }

      const q = this.norm(this.q);
      if(!q) return true;
      const hay = `${r.id} ${this.norm(r.name)} ${this.norm(r.email)}`;
      return hay.includes(q);
    },
    get filtered(){
      const out = this.rows.filter(r => this.passesFilters(r));
      const k = this.sortKey, dir = this.sortDir==='asc' ? 1 : -1;
      out.sort((a,b)=>{
        let va=a[k], vb=b[k];
        if(typeof va==='string') va=va.toLowerCase();
        if(typeof vb==='string') vb=vb.toLowerCase();
        if(va<vb) return -1*dir;
        if(va>vb) return  1*dir;
        return 0;
      });
      return out;
    },

    get pageCount(){ return Math.max(1, Math.ceil(this.filtered.length / this.pageSize)); },
    get pageStart(){ return (this.page-1)*this.pageSize; },
    get pageEnd(){ return this.pageStart + this.pageSize; },
    get pageRows(){
      if(this.page > this.pageCount) this.page = this.pageCount;
      return this.filtered.slice(this.pageStart, this.pageEnd);
    },

    copyEmails(){
      const list = (this.selected.size ? this.rows.filter(r=>this.selected.has(r.id)) : this.filtered).map(r=>r.email);
      if(!list.length) return;
      navigator.clipboard.writeText(list.join(', '))
        .then(()=>alert('Email‚Äô—ã —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω—ã'))
        .catch(()=>alert('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å'));
    },
    exportCSV(){
      const data = (this.selected.size ? this.rows.filter(r=>this.selected.has(r.id)) : this.filtered);
      if(!data.length) return;
      const header = ['id','name','email','is_trainer','has_subscription','meal_today','activity_today'];
      const lines = [header.join(',')].concat(
        data.map(r => [r.id, r.name, r.email, r.is_trainer, r.has_subscription, r.meal_today, r.activity_today]
          .map(v => `"${String(v).replaceAll('"','""')}"`).join(','))
      );
      const blob = new Blob([lines.join('\n')], {type:'text/csv;charset=utf-8;'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'users.csv';
      a.click();
      URL.revokeObjectURL(a.href);
    },

    deleteUser(id, name){
      if(!confirm(`–£–¥–∞–ª–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ${name}? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–æ–±—Ä–∞—Ç–∏–º–æ.`)) return;
      const f = document.createElement('form');
      f.method = 'POST';
      f.action = this.urls.delete + id;
      document.body.appendChild(f);
      f.submit();
    },
    sendMagic(id){
      if(!confirm('–û—Ç–ø—Ä–∞–≤–∏—Ç—å –º–∞–≥–∏—á–µ—Å–∫—É—é —Å—Å—ã–ª–∫—É –¥–ª—è –≤—Ö–æ–¥–∞?')) return;
      const f = document.createElement('form');
      f.method = 'POST';
      f.action = this.urls.magic + id;
      document.body.appendChild(f);
      f.submit();
    },

    // NEW: Send Mass Notification
    async sendNotification() {
        if (!this.notifTitle.trim() || !this.notifBody.trim()) {
            alert('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –∑–∞–≥–æ–ª–æ–≤–æ–∫ –∏ —Ç–µ–∫—Å—Ç');
            return;
        }

        const userIds = Array.from(this.selected);
        if (userIds.length === 0) {
            alert('–ù–µ—Ç –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π');
            return;
        }

        if(!confirm(`–û—Ç–ø—Ä–∞–≤–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ ${userIds.length} –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º?`)) return;

        try {
            const res = await fetch(this.urls.notify_send, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    user_ids: userIds,
                    title: this.notifTitle,
                    body: this.notifBody
                })
            });
            const data = await res.json();
            if (data.ok) {
                alert(`–£—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ: ${data.sent} –∏–∑ ${data.total}`);
                this.notifyModalOpen = false;
                this.notifTitle = '';
                this.notifBody = '';
                this.clearSelection();
            } else {
                alert('–û—à–∏–±–∫–∞: ' + (data.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
            }
        } catch (e) {
            alert('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ' + e);
        }
    }
  }
}
</script>

<style>
    [x-cloak] { display: none !important; }
</style>
{% endblock %}