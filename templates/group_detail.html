{% extends "base.html" %}
{% set title = group.name ~ " ‚Äî –ö–æ–º–∞–Ω–¥–Ω—ã–π —Ü–µ–Ω—Ç—Ä" %}

{% block content %}
<style>
  /* –ê–Ω–∏–º–∞—Ü–∏–∏ */
  .fade-in { animation: fadeIn 0.4s ease-out; }
  @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

  /* –ö–∞—Ä—Ç–æ—á–∫–∏ */
  .card {
    background: #fff;
    border: 1px solid #e5e7eb;
    border-radius: 20px;
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03);
    overflow: hidden;
  }

  /* –•–µ–¥–µ—Ä */
  .header-bg {
    background: linear-gradient(135deg, #4f46e5 0%, #6366f1 50%, #3b82f6 100%);
    color: white;
  }

  /* –õ–∏–¥–µ—Ä–±–æ—Ä–¥ */
  .leaderboard-row { transition: all 0.2s; border-bottom: 1px solid #f8fafc; }
  .leaderboard-row:last-child { border-bottom: none; }
  .leaderboard-row:hover { background-color: #f8fafc; transform: translateX(2px); }

  .rank-badge {
    width: 26px; height: 26px;
    display: flex; align-items: center; justify-content: center;
    border-radius: 50%; font-size: 12px; font-weight: 800;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
  }
  .rank-1 { background: linear-gradient(135deg, #FFD700, #FDB931); color: #92400E; border: 2px solid #FFFBEB; }
  .rank-2 { background: linear-gradient(135deg, #E0E0E0, #BDBDBD); color: #374151; border: 2px solid #F3F4F6; }
  .rank-3 { background: linear-gradient(135deg, #CD7F32, #A0522D); color: #78350F; border: 2px solid #FFF7ED; }
  .rank-N { background: #F1F5F9; color: #64748B; font-weight: 600; }

  /* –õ–µ–Ω—Ç–∞ */
  .feed-avatar { width: 42px; height: 42px; border-radius: 50%; object-fit: cover; border: 2px solid #fff; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
  .comment-avatar { width: 32px; height: 32px; border-radius: 50%; object-fit: cover; }
  .post-img { max-height: 500px; width: 100%; object-fit: cover; border-radius: 12px; margin-top: 12px; border: 1px solid #e5e7eb; cursor: zoom-in; }

  /* –ö–Ω–æ–ø–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π */
  .action-btn { transition: all 0.2s; }
  .action-btn:active { transform: scale(0.95); }
</style>

<div class="max-w-6xl mx-auto px-4 py-6 space-y-6">

  {# --- 1. –®–ê–ü–ö–ê –ì–†–£–ü–ü–´ --- #}
  <div class="card header-bg p-6 md:p-8 relative shadow-lg">
    <div class="absolute top-0 right-0 -mt-10 -mr-10 w-64 h-64 bg-white opacity-10 rounded-full blur-3xl pointer-events-none"></div>
    <div class="absolute bottom-0 left-0 -mb-10 -ml-10 w-40 h-40 bg-white opacity-10 rounded-full blur-2xl pointer-events-none"></div>

    <div class="relative z-10 flex flex-col md:flex-row items-center md:items-start gap-6">
      <div class="shrink-0 relative group">
        <img src="{{ url_for('serve_file', filename=group.trainer.avatar.filename) if group.trainer and group.trainer.avatar else url_for('static', filename='default-avatar.png') }}"
             class="w-24 h-24 md:w-28 md:h-28 rounded-full border-4 border-white/40 object-cover shadow-xl">
        <div class="absolute -bottom-2 -right-2 bg-white text-indigo-600 text-[10px] font-black px-2.5 py-1 rounded-full shadow-md uppercase tracking-wider border border-indigo-100">
          Head Coach
        </div>
      </div>

      <div class="text-center md:text-left flex-1 min-w-0">
        <div class="flex flex-col md:flex-row md:items-center gap-2 mb-2">
            <h1 class="text-3xl md:text-4xl font-black tracking-tight leading-tight truncate">{{ group.name }}</h1>
            {% if group.trainer_id == current_user.id %}
                <span class="bg-white/20 px-2 py-0.5 rounded text-xs font-medium border border-white/20 self-center md:self-auto">–í–∞—à –æ—Ç—Ä—è–¥</span>
            {% endif %}
        </div>

        <p class="text-indigo-100 text-base md:text-lg font-medium max-w-2xl mx-auto md:mx-0 line-clamp-2">
          {{ group.description or "–ö–æ–º–∞–Ω–¥–Ω—ã–π –¥—É—Ö –∏ –¥–∏—Å—Ü–∏–ø–ª–∏–Ω–∞ ‚Äî –∫–ª—é—á –∫ –ø–æ–±–µ–¥–µ." }}
        </p>

        <div class="mt-6 flex flex-wrap justify-center md:justify-start gap-3">
          <div class="inline-flex items-center px-4 py-2 rounded-full bg-white/10 backdrop-blur-md text-sm font-semibold border border-white/20 shadow-sm">
            <i class="bi bi-people-fill mr-2 opacity-80"></i> {{ members_data|length }} –∞—Ç–ª–µ—Ç–æ–≤
          </div>

          {% if current_user.is_trainer and group.trainer_id == current_user.id %}
            <button onclick="openModal('members-modal')" class="inline-flex items-center px-4 py-2 rounded-full bg-white text-indigo-700 text-sm font-bold shadow-lg hover:bg-indigo-50 hover:-translate-y-0.5 transition action-btn">
              <i class="bi bi-person-gear mr-2"></i> –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ
            </button>
            <a href="{{ url_for('admin_groups_list') }}" class="inline-flex items-center px-4 py-2 rounded-full bg-indigo-900/30 text-white text-sm font-bold hover:bg-indigo-900/50 transition border border-white/10 action-btn">
              <i class="bi bi-gear-fill mr-2"></i> –ù–∞—Å—Ç—Ä–æ–π–∫–∏
            </a>
          {% endif %}
        </div>
      </div>
    </div>
  </div>

  <div class="grid grid-cols-1 lg:grid-cols-12 gap-6">

    {# --- –õ–ï–í–ê–Ø –ö–û–õ–û–ù–ö–ê (35%) --- #}
    <div class="lg:col-span-4 space-y-6">

      {# --- 2. –†–ê–°–ü–ò–°–ê–ù–ò–ï --- #}
      <div class="card p-5 border-t-4 border-t-indigo-500">
        <div class="flex items-center justify-between mb-5">
          <h2 class="text-lg font-bold text-gray-900 flex items-center gap-2">
            <i class="bi bi-calendar-event text-indigo-500"></i> –†–∞—Å–ø–∏—Å–∞–Ω–∏–µ
          </h2>
          {% if current_user.is_trainer and group.trainer_id == current_user.id %}
            <button onclick="openModal('training-modal')"
                    class="w-7 h-7 rounded-full bg-indigo-50 text-indigo-600 flex items-center justify-center hover:bg-indigo-100 transition shadow-sm action-btn"
                    title="–î–æ–±–∞–≤–∏—Ç—å">
              <i class="bi bi-plus-lg text-lg font-bold"></i>
            </button>
          {% endif %}
        </div>

        {% if upcoming_trainings %}
          <div class="space-y-3">
            {% for t in upcoming_trainings %}
              <div class="group relative bg-white border border-gray-100 rounded-xl p-3 shadow-sm hover:shadow-md transition hover:border-indigo-100">

                {% if current_user.is_trainer and group.trainer_id == current_user.id %}
                  <button onclick="deleteTraining({{ t.id }})"
                          class="absolute top-2 right-2 text-gray-300 hover:text-red-500 opacity-0 group-hover:opacity-100 transition p-1">
                    <i class="bi bi-trash3-fill"></i>
                  </button>
                {% endif %}

                <div class="flex gap-3 items-center">
                  <div class="flex flex-col items-center justify-center w-12 h-12 bg-indigo-50 rounded-lg text-indigo-700 shrink-0 border border-indigo-100">
                    <span class="text-[10px] font-bold uppercase tracking-wider">{{ t.date.strftime('%b') }}</span>
                    <span class="text-xl font-black leading-none">{{ t.date.day }}</span>
                  </div>

                  <div class="flex-1 min-w-0">
                    <h3 class="font-bold text-gray-900 truncate text-sm">{{ t.title }}</h3>
                    <div class="text-xs text-gray-500 flex items-center gap-3 mt-1">
                      <span class="flex items-center gap-1 bg-gray-50 px-1.5 py-0.5 rounded"><i class="bi bi-clock"></i> {{ t.start_time.strftime('%H:%M') }}</span>
                      {% if t.meeting_link %}
                        <a href="{{ t.meeting_link }}" target="_blank" class="text-indigo-600 hover:underline flex items-center gap-1 font-medium">
                          <i class="bi bi-camera-video-fill"></i> –í—Ö–æ–¥
                        </a>
                      {% endif %}
                    </div>
                  </div>
                </div>
              </div>
            {% endfor %}
          </div>
        {% else %}
          <div class="text-center py-6 bg-gray-50 rounded-xl border border-dashed border-gray-200">
            <span class="text-sm text-gray-400 font-medium">–°–æ–±—ã—Ç–∏–π –Ω–µ—Ç</span>
          </div>
        {% endif %}
      </div>

      {# --- 3. –õ–ò–î–ï–†–ë–û–†–î (–ò–°–ü–†–ê–í–õ–ï–ù–ù–´–ô) --- #}
      <div class="card p-5 border-t-4 border-t-amber-400">
        <div class="flex items-center justify-between mb-4">
          <h2 class="text-lg font-bold text-gray-900 flex items-center gap-2">
            <i class="bi bi-trophy-fill text-amber-400"></i> –¢–æ–ø –Ω–µ–¥–µ–ª–∏
          </h2>
          <button onclick="toggleLeaderboard()" id="lb-toggle-btn" class="text-[10px] font-bold text-gray-400 hover:text-indigo-600 uppercase tracking-wide transition border border-gray-200 px-2 py-1 rounded hover:bg-gray-50">
            –ü–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ—Ö
          </button>
        </div>

        <div class="flex flex-col space-y-1" id="leaderboard-container">
          {# –§–∏–ª—å—Ç—Ä—É–µ–º —Ç—Ä–µ–Ω–µ—Ä–∞ –∏–∑ –ª–∏–¥–µ—Ä–±–æ—Ä–¥–∞, —á—Ç–æ–±—ã —Å–æ—Ä–µ–≤–Ω–æ–≤–∞–ª–∏—Å—å —Ç–æ–ª—å–∫–æ —É—á–∞—Å—Ç–Ω–∏–∫–∏ #}
          {% set members = members_data|selectattr("is_trainer", "equalto", false)|list %}

          {% for m in members %}
            <div class="leaderboard-row flex items-center justify-between py-2 px-2 rounded-lg {{ 'hidden' if loop.index > 5 else '' }} {{ 'bg-amber-50 border-amber-100' if m.user.id == current_user.id else '' }}"
                 data-rank="{{ loop.index }}">
              <div class="flex items-center gap-3">
                <div class="rank-badge rank-{{ loop.index if loop.index <= 3 else 'N' }}">
                  {{ loop.index }}
                </div>
                <div class="relative">
                    <img src="{{ url_for('serve_file', filename=m.user.avatar.filename) if m.user.avatar else url_for('static', filename='default-avatar.png') }}"
                         class="w-8 h-8 rounded-full object-cover shadow-sm bg-gray-100">
                    {% if m.is_inactive %}
                        <span class="absolute -bottom-1 -right-1 flex h-3 w-3">
                          <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-gray-400 opacity-75"></span>
                          <span class="relative inline-flex rounded-full h-3 w-3 bg-gray-500 border-2 border-white"></span>
                        </span>
                    {% endif %}
                </div>
                <div>
                  <div class="text-xs font-bold text-gray-800 leading-tight truncate max-w-[120px]">
                    {{ m.user.name }}
                  </div>
                  {% if m.user.id == current_user.id %}
                    <div class="text-[9px] font-bold text-indigo-600">–í—ã</div>
                  {% endif %}
                </div>
              </div>

              <div class="text-right">
                <div class="text-sm font-black text-gray-800">{{ m.score }}</div>
                <div class="text-[9px] text-gray-400 font-bold uppercase">pts</div>
              </div>
            </div>
          {% endfor %}

          {% if not members %}
             <div class="text-center text-gray-400 text-sm py-4">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</div>
          {% endif %}
        </div>
      </div>

    </div>

    {# --- –ü–†–ê–í–ê–Ø –ö–û–õ–û–ù–ö–ê (65%) --- #}
    <div class="lg:col-span-8 space-y-6">

      {# –§–æ—Ä–º–∞ –ø–æ—Å—Ç–∞ (–¢–æ–ª—å–∫–æ –¥–ª—è —Ç—Ä–µ–Ω–µ—Ä–∞) #}
      {% if current_user.is_trainer and group.trainer_id == current_user.id %}
      <div class="card p-5 shadow-md border-indigo-100 relative overflow-hidden">
        <div class="absolute top-0 right-0 w-20 h-20 bg-indigo-50 rounded-bl-full -mr-10 -mt-10 z-0"></div>

        <div class="flex gap-4 relative z-10">
          <img src="{{ url_for('serve_file', filename=current_user.avatar.filename) if current_user.avatar else url_for('static', filename='default-avatar.png') }}"
               class="w-10 h-10 rounded-full object-cover shadow-sm border border-gray-100 hidden sm:block">
          <div class="flex-1">
            <form id="create-post-form" onsubmit="submitPost(event)">
              <div class="relative">
                <textarea name="text" rows="2" placeholder="–ù–∞–ø–∏—à–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –¥–ª—è –∫–æ–º–∞–Ω–¥—ã..."
                          class="w-full bg-gray-50 border border-gray-200 rounded-xl px-4 py-3 text-sm focus:ring-2 focus:ring-indigo-500 focus:border-transparent resize-none transition-all focus:bg-white"></textarea>

                <div id="image-preview-container" class="hidden mt-3 relative inline-block group">
                  <img id="image-preview" src="" class="h-24 rounded-lg border border-gray-200 shadow-sm object-cover">
                  <div class="absolute inset-0 bg-black/20 rounded-lg opacity-0 group-hover:opacity-100 transition flex items-center justify-center">
                    <button type="button" onclick="clearImage()" class="bg-red-500 text-white rounded-full w-7 h-7 flex items-center justify-center hover:bg-red-600 transition shadow-sm">
                      <i class="bi bi-trash-fill text-xs"></i>
                    </button>
                  </div>
                </div>
              </div>

              <div class="flex items-center justify-between mt-3">
                <button type="button" onclick="document.getElementById('post-image-input').click()"
                        class="text-gray-500 hover:text-indigo-600 hover:bg-indigo-50 px-3 py-1.5 rounded-lg transition text-xs font-bold uppercase tracking-wide flex items-center gap-2">
                  <i class="bi bi-image text-lg"></i> <span>–§–æ—Ç–æ</span>
                </button>
                <input type="file" name="image" id="post-image-input" class="hidden" accept="image/*" onchange="previewImage(this)">

                <button type="submit" class="bg-indigo-600 text-white px-5 py-2 rounded-lg text-sm font-bold shadow-md hover:bg-indigo-700 hover:shadow-lg transition transform hover:-translate-y-0.5 action-btn">
                  –û—Ç–ø—Ä–∞–≤–∏—Ç—å <i class="bi bi-send-fill ml-1.5"></i>
                </button>
              </div>
            </form>
          </div>
        </div>
      </div>
      {% endif %}

      <div id="feed-container" class="space-y-6 pb-10">
        <div class="text-center py-12">
          <div class="animate-spin inline-block w-8 h-8 border-2 border-current border-t-transparent text-indigo-600 rounded-full" role="status"></div>
        </div>
      </div>

    </div>
  </div>
</div>

{# --- –ú–û–î–ê–õ–ö–ò –ò LIGHTBOX --- #}

<div id="image-lightbox" onclick="closeLightbox()" class="fixed inset-0 z-[100] hidden bg-black/90 flex items-center justify-center cursor-zoom-out p-4 backdrop-blur-sm transition-opacity opacity-0">
  <img id="lightbox-image" src="" class="max-w-full max-h-[90vh] rounded shadow-2xl transform scale-95 transition-transform duration-300 select-none">
</div>

{# –ú–æ–¥–∞–ª–∫–∞ –¢–†–ï–ù–ò–†–û–í–ö–ò #}
<div id="training-modal" class="fixed inset-0 z-50 hidden">
  <div class="absolute inset-0 bg-gray-900/60 backdrop-blur-sm transition-opacity" onclick="closeModal('training-modal')"></div>
  <div class="flex items-center justify-center min-h-screen p-4">
    <div class="bg-white rounded-2xl w-full max-w-md p-6 shadow-2xl relative transform transition-all scale-95 opacity-0 modal-content">
      <div class="flex justify-between items-center mb-6">
        <h3 class="text-xl font-black text-gray-900">–ù–æ–≤–æ–µ —Å–æ–±—ã—Ç–∏–µ</h3>
        <button onclick="closeModal('training-modal')" class="w-8 h-8 rounded-full bg-gray-100 flex items-center justify-center text-gray-500 hover:bg-gray-200 transition">
          <i class="bi bi-x-lg"></i>
        </button>
      </div>

      <form onsubmit="submitTraining(event)" class="space-y-4">
        <div>
          <label class="block text-xs font-bold text-gray-500 uppercase mb-1 ml-1">–ù–∞–∑–≤–∞–Ω–∏–µ</label>
          <input type="text" name="title" required value="–ì—Ä—É–ø–ø–æ–≤–∞—è —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞" class="w-full bg-gray-50 border border-gray-200 rounded-xl px-4 py-3 text-sm focus:ring-2 focus:ring-indigo-500 focus:border-transparent outline-none transition">
        </div>

        <div class="grid grid-cols-2 gap-4">
          <div>
            <label class="block text-xs font-bold text-gray-500 uppercase mb-1 ml-1">–î–∞—Ç–∞</label>
            <input type="date" name="date" required class="w-full bg-gray-50 border border-gray-200 rounded-xl px-4 py-3 text-sm outline-none">
          </div>
          <div>
            <label class="block text-xs font-bold text-gray-500 uppercase mb-1 ml-1">–ù–∞—á–∞–ª–æ</label>
            <input type="time" name="start_time" required class="w-full bg-gray-50 border border-gray-200 rounded-xl px-4 py-3 text-sm outline-none">
          </div>
        </div>

        <div class="grid grid-cols-2 gap-4">
          <div>
            <label class="block text-xs font-bold text-gray-500 uppercase mb-1 ml-1">–ö–æ–Ω–µ—Ü</label>
            <input type="time" name="end_time" required class="w-full bg-gray-50 border border-gray-200 rounded-xl px-4 py-3 text-sm outline-none">
          </div>
          <div>
             <label class="block text-xs font-bold text-gray-500 uppercase mb-1 ml-1">Zoom Link</label>
             <input type="url" name="meeting_link" placeholder="https://" class="w-full bg-gray-50 border border-gray-200 rounded-xl px-4 py-3 text-sm outline-none">
          </div>
        </div>

        <div>
          <label class="block text-xs font-bold text-gray-500 uppercase mb-1 ml-1">–ó–∞–º–µ—Ç–∫–∏</label>
          <textarea name="description" rows="3" class="w-full bg-gray-50 border border-gray-200 rounded-xl px-4 py-3 text-sm outline-none resize-none"></textarea>
        </div>

        <button type="submit" class="w-full bg-indigo-600 text-white py-3.5 rounded-xl font-bold hover:bg-indigo-700 transition shadow-lg shadow-indigo-200 mt-2 action-btn">
          –ù–∞–∑–Ω–∞—á–∏—Ç—å —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫—É
        </button>
      </form>
    </div>
  </div>
</div>

{# –ú–æ–¥–∞–ª–∫–∞ –£–ß–ê–°–¢–ù–ò–ö–ò #}
<div id="members-modal" class="fixed inset-0 z-50 hidden">
  <div class="absolute inset-0 bg-gray-900/60 backdrop-blur-sm transition-opacity" onclick="closeModal('members-modal')"></div>
  <div class="flex items-center justify-center min-h-screen p-4">
    <div class="bg-white rounded-2xl w-full max-w-lg p-0 shadow-2xl relative transform transition-all scale-95 opacity-0 modal-content overflow-hidden flex flex-col max-h-[85vh]">
      <div class="p-5 border-b border-gray-100 flex justify-between items-center bg-gray-50">
        <div>
          <h3 class="text-xl font-black text-gray-900">–°–æ—Å—Ç–∞–≤ –∫–æ–º–∞–Ω–¥—ã</h3>
          <p class="text-xs text-gray-500 font-medium mt-1">–í—Å–µ–≥–æ: {{ members_data|length }} —á–µ–ª.</p>
        </div>
        <button onclick="closeModal('members-modal')" class="w-8 h-8 rounded-full bg-white border border-gray-200 flex items-center justify-center text-gray-500 hover:bg-gray-100 transition">
          <i class="bi bi-x-lg"></i>
        </button>
      </div>

    <div class="overflow-y-auto p-2 scrollbar-thin">
        {% for m in members_data if not m.is_trainer %}
          <div class="flex items-center justify-between p-3 hover:bg-gray-50 rounded-xl group transition border border-transparent hover:border-gray-100">
            <div class="flex items-center gap-3">
              <div class="relative">
                <img src="{{ url_for('serve_file', filename=m.user.avatar.filename) if m.user.avatar else url_for('static', filename='default-avatar.png') }}"
                     class="w-10 h-10 rounded-full object-cover border border-gray-200 {{ 'grayscale opacity-70' if m.is_inactive else '' }}">

                {% if m.is_inactive %}
                  <div class="absolute -bottom-1 -right-1 bg-white rounded-full p-0.5 shadow-sm" title="–ù–µ–∞–∫—Ç–∏–≤–µ–Ω {{ m.days_inactive }} –¥–Ω.">
                    <div class="w-4 h-4 bg-amber-100 rounded-full flex items-center justify-center text-[9px]">üí§</div>
                  </div>
                {% endif %}
              </div>

              <div>
                <div class="font-bold text-gray-900 text-sm flex items-center gap-2">
                  {{ m.user.name }}
                  {% if m.is_inactive %}
                    <span class="text-[9px] bg-amber-50 text-amber-600 px-1.5 py-0.5 rounded font-bold border border-amber-100">{{ m.days_inactive }}–¥ –Ω–µ –≤ —Å–µ—Ç–∏</span>
                  {% endif %}
                </div>
                <div class="text-xs text-gray-400">{{ m.user.email }}</div>
              </div>
            </div>

            <div class="flex items-center gap-2 opacity-0 group-hover:opacity-100 transition-opacity">
                {% if m.is_inactive %}
                  <button onclick="nudgeUser({{ m.user.id }}, this)"
                          class="bg-amber-100 text-amber-600 hover:bg-amber-200 p-2 rounded-lg transition"
                          title="–ù–∞–ø–æ–º–Ω–∏—Ç—å">
                    <i class="bi bi-bell-fill text-sm"></i>
                  </button>
                {% endif %}

                <form action="{{ url_for('admin_delete_user', user_id=m.user.id) }}" method="POST" onsubmit="return confirm('–ò—Å–∫–ª—é—á–∏—Ç—å –∏–∑ –≥—Ä—É–ø–ø—ã –∏ —É–¥–∞–ª–∏—Ç—å –¥–∞–Ω–Ω—ã–µ?');">
                   <button type="submit" class="text-gray-300 hover:text-red-500 hover:bg-red-50 p-2 rounded-lg transition" title="–ò—Å–∫–ª—é—á–∏—Ç—å">
                     <i class="bi bi-person-x-fill text-lg"></i>
                   </button>
                </form>
            </div>
          </div>
        {% endfor %}
      </div>
    </div>
  </div>
</div>

<script>
  const GROUP_ID = {{ group.id }};
  const CURRENT_USER_ID = {{ current_user.id }};
  const IS_TRAINER = {{ 'true' if current_user.is_trainer and group.trainer_id == current_user.id else 'false' }};

  // --- MODAL UTILS ---
  function openModal(id) {
    const el = document.getElementById(id);
    el.classList.remove('hidden');
    setTimeout(() => {
      el.querySelector('.modal-content').classList.remove('scale-95', 'opacity-0');
      el.querySelector('.modal-content').classList.add('scale-100', 'opacity-100');
    }, 10);
  }

  function closeModal(id) {
    const el = document.getElementById(id);
    el.querySelector('.modal-content').classList.remove('scale-100', 'opacity-100');
    el.querySelector('.modal-content').classList.add('scale-95', 'opacity-0');
    setTimeout(() => {
      el.classList.add('hidden');
    }, 200);
  }

  // --- –¢–†–ï–ù–ò–†–û–í–ö–ò ---
  async function submitTraining(e) {
    e.preventDefault();
    const form = e.target;
    const formData = new FormData(form);

    try {
      const res = await fetch(`/groups/${GROUP_ID}/trainings/new`, { method: 'POST', body: formData });
      const data = await res.json();
      if (data.ok) window.location.reload();
      else alert(data.error);
    } catch (err) { alert('–û—à–∏–±–∫–∞'); }
  }

  async function deleteTraining(tid) {
    if(!confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç—É —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫—É?')) return;
    try {
      const res = await fetch(`/api/trainings/${tid}`, { method: 'DELETE' });
      const data = await res.json();
      if(data.ok) window.location.reload();
    } catch(e) { alert('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è'); }
  }

  // --- –õ–ò–î–ï–†–ë–û–†–î ---
  let lbExpanded = false;
  function toggleLeaderboard() {
    lbExpanded = !lbExpanded;
    const rows = document.querySelectorAll('.leaderboard-row');
    const btn = document.getElementById('lb-toggle-btn');
    rows.forEach((row, index) => {
      if (index >= 5) row.classList.toggle('hidden', !lbExpanded);
    });
    btn.innerText = lbExpanded ? "–°–≤–µ—Ä–Ω—É—Ç—å" : "–ü–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ—Ö";
  }

  // --- –õ–ï–ù–¢–ê (POSTS) ---
  function previewImage(input) {
    if (input.files && input.files[0]) {
      const reader = new FileReader();
      reader.onload = function(e) {
        document.getElementById('image-preview').src = e.target.result;
        document.getElementById('image-preview-container').classList.remove('hidden');
      }
      reader.readAsDataURL(input.files[0]);
    }
  }

  function clearImage() {
    document.getElementById('post-image-input').value = '';
    document.getElementById('image-preview-container').classList.add('hidden');
  }

  async function submitPost(e) {
    e.preventDefault();
    const form = e.target;
    const formData = new FormData(form);
    if (!formData.get('text').trim() && !formData.get('image').size) return;

    try {
      const res = await fetch(`/api/groups/${GROUP_ID}/post`, { method: 'POST', body: formData });
      const data = await res.json();
      if (data.ok) { form.reset(); clearImage(); loadFeed(); }
      else alert(data.error);
    } catch (err) { alert('–û—à–∏–±–∫–∞'); }
  }

  async function loadFeed() {
    const container = document.getElementById('feed-container');
    try {
      const res = await fetch(`/api/groups/${GROUP_ID}/feed`);
      const data = await res.json();
      if (data.ok) renderFeed(data.feed);
    } catch (err) {
      container.innerHTML = `<div class="text-center text-red-500 py-10">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ª–µ–Ω—Ç—ã</div>`;
    }
  }

  async function deletePost(postId) {
    if(!confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç –ø–æ—Å—Ç?')) return;
    alert('API —É–¥–∞–ª–µ–Ω–∏—è –ø–æ—Å—Ç–∞ –ø–æ–∫–∞ –Ω–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ');
  }

  function renderFeed(posts) {
    const container = document.getElementById('feed-container');
    if (posts.length === 0) {
      container.innerHTML = `
        <div class="text-center py-16 bg-gray-50 rounded-xl border border-dashed border-gray-200">
          <div class="w-16 h-16 bg-white rounded-full flex items-center justify-center mx-auto mb-4 text-gray-300 shadow-sm">
            <i class="bi bi-chat-square-text text-2xl"></i>
          </div>
          <h3 class="text-gray-900 font-bold">–õ–µ–Ω—Ç–∞ –ø—É—Å—Ç–∞</h3>
          <p class="text-gray-500 text-sm mt-1">–û–ø—É–±–ª–∏–∫—É–π—Ç–µ –ø–µ—Ä–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –¥–ª—è –∫–æ–º–∞–Ω–¥—ã</p>
        </div>`;
      return;
    }

    container.innerHTML = posts.map(post => {
      const isSystem = post.type === 'system';
      // –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–π –ø—É—Ç—å –∫ —Ñ–∞–π–ª–∞–º (—É–±–∏—Ä–∞–µ–º 'files/' –µ—Å–ª–∏ –æ–Ω —É–∂–µ –µ—Å—Ç—å –≤ API, –Ω–æ –æ–±—ã—á–Ω–æ API –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∏–º—è —Ñ–∞–π–ª–∞)
      const userAvatar = post.avatar ? `/files/${post.avatar}` : '/static/default-avatar.png';
      const postImage = post.image ? `/files/${post.image}` : null;

      const canDelete = IS_TRAINER || post.user_id === CURRENT_USER_ID;

      const commentsHtml = post.comments.map(c => `
        <div class="flex gap-3 mb-3 group/comment">
          <img src="${c.avatar ? `/files/${c.avatar}` : '/static/default-avatar.png'}" class="comment-avatar shrink-0 mt-1 bg-white">
          <div class="flex-1">
            <div class="bg-white border border-gray-200 px-4 py-2 rounded-2xl rounded-tl-none inline-block max-w-full shadow-sm">
              <span class="font-bold text-gray-900 text-xs block mb-0.5">${c.user_name}</span>
              <p class="text-gray-800 text-sm leading-snug">${c.text}</p>
            </div>
            <div class="text-[10px] text-gray-400 mt-1 ml-1 font-medium">${c.timestamp}</div>
          </div>
        </div>
      `).join('');

      return `
        <article class="card fade-in overflow-visible" id="post-${post.id}">
          <div class="p-5">
            <div class="flex items-start justify-between">
              <div class="flex items-center gap-3 mb-3">
                ${isSystem
                  ? `<div class="w-10 h-10 rounded-full bg-green-100 flex items-center justify-center text-green-600 shadow-sm border border-green-200"><i class="bi bi-trophy-fill"></i></div>`
                  : `<img src="${userAvatar}" class="feed-avatar bg-gray-100">`
                }
                <div>
                  <div class="font-bold text-gray-900 text-sm flex items-center gap-2">
                    ${post.user_name}
                    ${!isSystem && post.user_id == {{ group.trainer_id }} ? '<span class="bg-indigo-50 text-indigo-700 text-[10px] px-1.5 py-0.5 rounded uppercase tracking-wider border border-indigo-100 font-bold">Coach</span>' : ''}
                  </div>
                  <div class="text-xs text-gray-400 font-medium">${post.timestamp}</div>
                </div>
              </div>

              ${ canDelete ? `
                <button onclick="deletePost(${post.id})" class="text-gray-300 hover:text-red-500 transition p-1.5 rounded-full hover:bg-red-50" title="–£–¥–∞–ª–∏—Ç—å">
                  <i class="bi bi-trash3"></i>
                </button>
              ` : ''}
            </div>

            <div class="text-gray-800 text-[15px] leading-relaxed whitespace-pre-wrap pl-1 font-medium">${post.text}</div>

            ${postImage ? `<div class="mt-3"><img src="${postImage}" class="post-img shadow-sm hover:shadow-md transition" onclick="openLightbox(this.src)"></div>` : ''}

            <div class="mt-4 flex items-center gap-4 border-t border-gray-100 pt-3">
              <button onclick="toggleLike(${post.id})" class="like-btn group flex items-center gap-2 text-sm font-semibold transition py-1.5 px-3 rounded-lg hover:bg-gray-50 ${post.is_liked ? 'text-red-500' : 'text-gray-500 hover:text-gray-700'}">
                <i class="bi ${post.is_liked ? 'bi-heart-fill' : 'bi-heart'} text-lg transition-transform group-active:scale-125"></i>
                <span class="likes-count">${post.likes_count > 0 ? post.likes_count : '–ù—Ä–∞–≤–∏—Ç—Å—è'}</span>
              </button>

              <button onclick="focusComment(${post.id})" class="group flex items-center gap-2 text-sm font-semibold text-gray-500 hover:text-indigo-600 transition py-1.5 px-3 rounded-lg hover:bg-gray-50">
                <i class="bi bi-chat text-lg"></i>
                <span>${post.comments.length > 0 ? post.comments.length : '–ö–æ–º–º–µ–Ω—Ç'}</span>
              </button>
            </div>
          </div>

          <div class="bg-gray-50/80 p-5 border-t border-gray-100 ${post.comments.length === 0 ? '' : 'pt-4'}">
            <div id="comments-list-${post.id}" class="space-y-1">
              ${commentsHtml}
            </div>

            <form onsubmit="submitComment(event, ${post.id})" class="flex gap-3 mt-4 items-center">
              <img src="{{ url_for('serve_file', filename=current_user.avatar.filename) if current_user.avatar else url_for('static', filename='default-avatar.png') }}" class="w-8 h-8 rounded-full object-cover border border-gray-200 shadow-sm">
              <div class="flex-1 relative group">
                <input type="text" name="text" placeholder="–ù–∞–ø–∏—Å–∞—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π..."
                       class="w-full bg-white border border-gray-200 shadow-sm rounded-full py-2.5 px-5 text-sm focus:ring-2 focus:ring-indigo-500 focus:border-transparent transition pr-10">
                <button type="submit" class="absolute right-2 top-1.5 w-8 h-8 flex items-center justify-center text-indigo-600 hover:bg-indigo-50 rounded-full transition">
                  <i class="bi bi-send-fill text-sm transform rotate-45 translate-x-px translate-y-px"></i>
                </button>
              </div>
            </form>
          </div>
        </article>
      `;
    }).join('');
  }

  // --- ACTIONS ---
  async function toggleLike(postId) {
    const postEl = document.getElementById(`post-${postId}`);
    const btn = postEl.querySelector('.like-btn');
    if (!btn) return;

    const icon = btn.querySelector('i');
    const countSpan = btn.querySelector('.likes-count');
    const isLiked = icon.classList.contains('bi-heart-fill');

    let count = parseInt(countSpan.innerText);
    if (isNaN(count)) count = 0;

    if (isLiked) {
      icon.classList.replace('bi-heart-fill', 'bi-heart');
      btn.classList.replace('text-red-500', 'text-gray-500');
      count = Math.max(0, count - 1);
    } else {
      icon.classList.replace('bi-heart', 'bi-heart-fill');
      btn.classList.replace('text-gray-500', 'text-red-500');
      count++;
    }
    countSpan.innerText = count > 0 ? count : '–ù—Ä–∞–≤–∏—Ç—Å—è';

    try { await fetch(`/group_message/${postId}/react`, { method: 'POST' }); } catch(e) {}
  }

  function focusComment(postId) {
    const input = document.querySelector(`#post-${postId} input[name="text"]`);
    if (input) input.focus();
  }

  async function submitComment(e, postId) {
    e.preventDefault();
    const input = e.target.text;
    const text = input.value.trim();
    if (!text) return;
    input.value = '';

    try {
      const res = await fetch(`/api/groups/${GROUP_ID}/reply`, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ parent_id: postId, text: text })
      });
      const data = await res.json();
      if (data.ok) loadFeed();
    } catch(err) {}
  }

  async function nudgeUser(userId, btn) {
    const originalContent = btn.innerHTML;
    btn.innerHTML = '<div class="animate-spin w-3 h-3 border-2 border-current border-t-transparent rounded-full"></div>';
    btn.disabled = true;

    try {
      const res = await fetch(`/api/groups/nudge/${userId}`, { method: 'POST' });
      const data = await res.json();
      if (data.ok) {
        btn.classList.remove('bg-amber-100', 'text-amber-600', 'hover:bg-amber-200');
        btn.classList.add('bg-green-100', 'text-green-600');
        btn.innerHTML = '<i class="bi bi-check-lg"></i>';
      } else {
        alert(data.error);
        btn.innerHTML = originalContent;
        btn.disabled = false;
      }
    } catch (e) {
      alert('–û—à–∏–±–∫–∞');
      btn.innerHTML = originalContent;
      btn.disabled = false;
    }
  }

  function openLightbox(src) {
    const lb = document.getElementById('image-lightbox');
    const img = document.getElementById('lightbox-image');
    lb.classList.remove('hidden');
    setTimeout(() => lb.classList.remove('opacity-0'), 10);
    img.src = src;
  }

  function closeLightbox() {
    const lb = document.getElementById('image-lightbox');
    lb.classList.add('opacity-0');
    setTimeout(() => lb.classList.add('hidden'), 300);
  }

  document.addEventListener('DOMContentLoaded', loadFeed);
</script>
{% endblock %}