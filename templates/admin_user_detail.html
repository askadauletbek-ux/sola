{% extends 'base.html' %}
{% block content %}

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
  window._chartsData = {
    activityLabels: {{ activity_chart_labels|safe }},
    steps: {{ activity_steps_values|safe }},
    kcal: {{ activity_kcal_values|safe }},
    weightLabels: {{ weight_chart_labels|safe }},
    weight: {{ weight_chart_values|safe }},
    fat: {{ fat_chart_values|safe }}
  };
</script>

<div class="max-w-7xl mx-auto px-4 py-8"
     x-data="{
       tab: 'overview',
       isSubModalOpen: false,
       unlinkOpen: false,

       init() {
         this.$nextTick(() => {
            this.renderCharts();
         });
       },

       renderCharts() {
         // –ì—Ä–∞—Ñ–∏–∫ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏
         const ctxSteps = document.getElementById('stepsChart');
         if (ctxSteps) {
             new Chart(ctxSteps, {
                 type: 'bar',
                 data: {
                     labels: window._chartsData.activityLabels,
                     datasets: [
                         { label: '–®–∞–≥–∏', data: window._chartsData.steps, backgroundColor: '#3b82f6', yAxisID: 'y' },
                         { label: '–ö–∫–∞–ª', data: window._chartsData.kcal, type: 'line', borderColor: '#ef4444', yAxisID: 'y1' }
                     ]
                 },
                 options: {
                     responsive: true,
                     maintainAspectRatio: false,
                     scales: {
                         y: { type: 'linear', display: true, position: 'left' },
                         y1: { type: 'linear', display: true, position: 'right', grid: { drawOnChartArea: false } }
                     }
                 }
             });
         }

         // –ì—Ä–∞—Ñ–∏–∫ –≤–µ—Å–∞
         const ctxBody = document.getElementById('bodyChart');
         if (ctxBody) {
             new Chart(ctxBody, {
                 type: 'line',
                 data: {
                     labels: window._chartsData.weightLabels,
                     datasets: [
                         { label: '–í–µ—Å (–∫–≥)', data: window._chartsData.weight, borderColor: '#10b981', tension: 0.3 },
                         { label: '–ñ–∏—Ä (–∫–≥)', data: window._chartsData.fat, borderColor: '#f59e0b', tension: 0.3 }
                     ]
                 },
                 options: { responsive: true, maintainAspectRatio: false }
             });
         }
       }
     }"
>

  <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4">
    <div class="flex items-center gap-4">
      <div class="relative">
        {% if user.avatar %}
          <img src="{{ url_for('serve_file', filename=user.avatar.filename) }}" class="w-16 h-16 rounded-full object-cover border-2 border-gray-200">
        {% else %}
          <div class="w-16 h-16 rounded-full bg-gray-200 flex items-center justify-center text-gray-500 text-xl font-bold">
            {{ user.name[:1] }}
          </div>
        {% endif %}
        {% if user.is_trainer %}
          <span class="absolute -bottom-1 -right-1 bg-blue-600 text-white text-xs px-2 py-0.5 rounded-full">–¢—Ä–µ–Ω–µ—Ä</span>
        {% endif %}
      </div>
      <div>
        <h1 class="text-2xl font-bold text-gray-900">{{ user.name }}</h1>
        <div class="text-sm text-gray-500 flex flex-wrap gap-3 items-center mt-1">
          <span>ID: {{ user.id }}</span>
          <span>‚Ä¢</span>
          <span>{{ user.email }}</span>

          {% if user.fcm_device_token %}
             <span class="bg-green-100 text-green-700 px-2 py-0.5 rounded text-xs" title="Push —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è —Ä–∞–±–æ—Ç–∞—é—Ç">üì± Push Active</span>
          {% else %}
             <span class="bg-gray-100 text-gray-500 px-2 py-0.5 rounded text-xs" title="–£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –Ω–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–æ">üîï No Push</span>
          {% endif %}

          {% if user.telegram_chat_id %}
             <span class="bg-blue-100 text-blue-700 px-2 py-0.5 rounded text-xs">‚úàÔ∏è Telegram</span>
          {% endif %}

          {% if user.is_verified %}
             <span class="bg-teal-100 text-teal-700 px-2 py-0.5 rounded text-xs">Verified</span>
          {% endif %}
        </div>
      </div>
    </div>

    <div class="flex gap-2">
      <a href="{{ url_for('admin_dashboard') }}" class="px-4 py-2 border rounded-lg hover:bg-gray-50 text-sm font-medium">‚Üê –ù–∞–∑–∞–¥</a>
    </div>
  </div>

  <div class="border-b border-gray-200 mb-6">
    <nav class="-mb-px flex space-x-8 overflow-x-auto" aria-label="Tabs">
      <button @click="tab = 'overview'"
              :class="tab === 'overview' ? 'border-indigo-500 text-indigo-600' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'"
              class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">
        –û–±–∑–æ—Ä
      </button>
      <button @click="tab = 'body'"
              :class="tab === 'body' ? 'border-indigo-500 text-indigo-600' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'"
              class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">
        –¢–µ–ª–æ –∏ –ó–¥–æ—Ä–æ–≤—å–µ
      </button>
      <button @click="tab = 'nutrition'"
              :class="tab === 'nutrition' ? 'border-indigo-500 text-indigo-600' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'"
              class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">
        –ü–∏—Ç–∞–Ω–∏–µ (–õ–æ–≥–∏)
      </button>
      <button @click="tab = 'settings'"
              :class="tab === 'settings' ? 'border-indigo-500 text-indigo-600' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'"
              class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">
        –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
      </button>
    </nav>
  </div>

  <div x-show="tab === 'overview'" x-cloak class="grid grid-cols-1 lg:grid-cols-3 gap-6">

    <div class="lg:col-span-2 space-y-6">
        <div class="grid grid-cols-2 sm:grid-cols-4 gap-4">
            <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-100">
                <div class="text-xs text-gray-500 uppercase">–°—Ç—Ä–∏–∫</div>
                <div class="text-2xl font-bold text-indigo-600">{{ user.current_streak }} üî•</div>
            </div>
            <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-100">
                <div class="text-xs text-gray-500 uppercase">–°—Ä. —à–∞–≥–∏ (7–¥)</div>
                <div class="text-2xl font-bold">{{ avg_steps }}</div>
                <div class="text-xs text-gray-400">–¶–µ–ª—å: {{ user.step_goal }}</div>
            </div>
            <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-100">
                <div class="text-xs text-gray-500 uppercase">–°—Ä. –∫–∫–∞–ª (7–¥)</div>
                <div class="text-2xl font-bold">{{ avg_cals }}</div>
                <div class="text-xs text-gray-400">–¶–µ–ª—å: {{ user.target_calories }}</div>
            </div>
            <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-100">
                <div class="text-xs text-gray-500 uppercase">–û—Ç—Ä—è–¥</div>
                {% if user.groups.first() %}
                    <a href="{{ url_for('group_detail', group_id=user.groups.first().group_id) }}" class="text-lg font-bold text-blue-600 hover:underline truncate block">
                        {{ user.groups.first().group.name }}
                    </a>
                {% else %}
                    <div class="text-lg font-bold text-gray-400">–ù–µ—Ç</div>
                {% endif %}
                <div class="text-xs text-gray-400">–°—Ç–∞—Ç—É—Å: {{ user.squad_status }}</div>
            </div>
        </div>

        <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100">
            <h3 class="font-semibold mb-4">–ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å (30 –¥–Ω–µ–π)</h3>
            <div class="h-64">
                <canvas id="stepsChart"></canvas>
            </div>
        </div>
    </div>

    <div class="space-y-6">
        <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100">
            <h3 class="font-semibold mb-4 flex items-center justify-between">
                –ü–æ–¥–ø–∏—Å–∫–∞
                <span class="px-2 py-1 text-xs rounded-full
                    {% if user.has_subscription %} bg-green-100 text-green-700 {% else %} bg-red-100 text-red-700 {% endif %}">
                    {{ '–ê–∫—Ç–∏–≤–Ω–∞' if user.has_subscription else '–ù–µ–∞–∫—Ç–∏–≤–Ω–∞' }}
                </span>
            </h3>

            {% if user.subscription %}
                <div class="space-y-2 text-sm text-gray-600 mb-4">
                    <div class="flex justify-between"><span>–ù–∞—á–∞–ª–æ:</span> <span class="font-medium">{{ user.subscription.start_date }}</span></div>
                    <div class="flex justify-between"><span>–ö–æ–Ω–µ—Ü:</span> <span class="font-medium">{{ user.subscription.end_date or '–ë–µ–∑–ª–∏–º–∏—Ç' }}</span></div>
                    <div class="flex justify-between"><span>–°—Ç–∞—Ç—É—Å –ë–î:</span> <span>{{ user.subscription.status }}</span></div>
                </div>
            {% else %}
                <p class="text-sm text-gray-500 mb-4">–ó–∞–ø–∏—Å–µ–π –æ –ø–æ–¥–ø–∏—Å–∫–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ.</p>
            {% endif %}

            <button @click="isSubModalOpen = true" class="w-full py-2 bg-indigo-50 text-indigo-700 rounded-lg hover:bg-indigo-100 font-medium text-sm">
                –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–¥–ø–∏—Å–∫–æ–π
            </button>
        </div>

        <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100">
            <h3 class="font-semibold mb-2">–ë—ã—Å—Ç—Ä—ã–π –≤—Ö–æ–¥</h3>
            <p class="text-xs text-gray-500 mb-3">–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å —Å—Å—ã–ª–∫—É –¥–ª—è –≤—Ö–æ–¥–∞ –±–µ–∑ –ø–∞—Ä–æ–ª—è.</p>
            <form method="post" action="{{ url_for('admin_send_magic_link', user_id=user.id) }}">
                <button class="w-full py-2 bg-gray-800 text-white rounded-lg hover:bg-gray-900 text-sm">
                    üîó –û—Ç–ø—Ä–∞–≤–∏—Ç—å Magic Link
                </button>
            </form>
        </div>

        <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100">
             <h3 class="font-semibold mb-2">–≠–∫—Å–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö</h3>
             <div class="flex gap-2">
                 <form method="post" action="{{ url_for('admin_user_export', user_id=user.id) }}" class="flex-1">
                    <input type="hidden" name="format" value="json">
                    <button class="w-full py-2 border rounded-lg hover:bg-gray-50 text-sm">JSON</button>
                  </form>
                  <form method="post" action="{{ url_for('admin_user_export', user_id=user.id) }}" class="flex-1">
                    <input type="hidden" name="format" value="csv">
                    <button class="w-full py-2 border rounded-lg hover:bg-gray-50 text-sm">CSV</button>
                  </form>
             </div>
        </div>
    </div>
  </div>

  <div x-show="tab === 'body'" x-cloak class="space-y-6">
      <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
          <div class="lg:col-span-2 bg-white p-6 rounded-xl shadow-sm border border-gray-100">
             <h3 class="font-semibold mb-4">–î–∏–Ω–∞–º–∏–∫–∞ –≤–µ—Å–∞ –∏ –∂–∏—Ä–∞</h3>
             <div class="h-80">
                 <canvas id="bodyChart"></canvas>
             </div>
          </div>

          <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100">
             <h3 class="font-semibold mb-4">–¢–µ–∫—É—â–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã</h3>
             {% set latest = user.latest_analysis %}
             {% if latest %}
                 <div class="space-y-4">
                     <div>
                         <div class="text-sm text-gray-500">–í–µ—Å</div>
                         <div class="text-2xl font-bold">{{ latest.weight }} <span class="text-sm font-normal text-gray-400">–∫–≥</span></div>
                     </div>
                     <div>
                        <div class="text-sm text-gray-500">–ñ–∏—Ä</div>
                        <div class="text-xl font-semibold">{{ latest.fat_mass }} <span class="text-sm font-normal text-gray-400">–∫–≥</span> ({{ "%.1f"|format(latest.fat_mass / latest.weight * 100) if latest.weight else 0 }}%)</div>
                    </div>
                    <div>
                        <div class="text-sm text-gray-500">–ú—ã—à—Ü—ã</div>
                        <div class="text-xl font-semibold">{{ latest.muscle_mass }} <span class="text-sm font-normal text-gray-400">–∫–≥</span></div>
                    </div>
                    <div>
                        <div class="text-sm text-gray-500">BMR (–ú–µ—Ç–∞–±–æ–ª–∏–∑–º)</div>
                        <div class="text-xl font-semibold">{{ latest.metabolism }} <span class="text-sm font-normal text-gray-400">–∫–∫–∞–ª</span></div>
                    </div>
                 </div>
                 <div class="mt-4 pt-4 border-t text-xs text-gray-400">
                     –î–∞—Ç–∞ –∑–∞–º–µ—Ä–∞: {{ latest.timestamp.strftime('%d.%m.%Y %H:%M') }}
                 </div>
             {% else %}
                 <p class="text-gray-500">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –∑–∞–º–µ—Ä–æ–≤.</p>
             {% endif %}
          </div>
      </div>

      <div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
          <div class="px-6 py-4 border-b bg-gray-50">
              <h3 class="font-semibold">–ò—Å—Ç–æ—Ä–∏—è –∑–∞–º–µ—Ä–æ–≤</h3>
          </div>
          <div class="overflow-x-auto">
            <table class="min-w-full text-sm text-left">
                <thead class="bg-gray-50 text-gray-500">
                    <tr>
                        <th class="px-6 py-3">–î–∞—Ç–∞</th>
                        <th class="px-6 py-3">–í–µ—Å</th>
                        <th class="px-6 py-3">–ñ–∏—Ä</th>
                        <th class="px-6 py-3">–ú—ã—à—Ü—ã</th>
                        <th class="px-6 py-3">–í–æ–¥–∞</th>
                        <th class="px-6 py-3">–í–∏—Å—Ü.</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-gray-100">
                    {% for a in body_analyses %}
                    <tr class="hover:bg-gray-50">
                        <td class="px-6 py-3 whitespace-nowrap">{{ a.timestamp.strftime('%d.%m.%Y') }}</td>
                        <td class="px-6 py-3 font-medium">{{ a.weight }}</td>
                        <td class="px-6 py-3">{{ a.fat_mass }}</td>
                        <td class="px-6 py-3">{{ a.muscle_mass }}</td>
                        <td class="px-6 py-3">{{ a.body_water }}</td>
                        <td class="px-6 py-3">{{ a.visceral_fat_rating }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
          </div>
      </div>
  </div>

  <div x-show="tab === 'nutrition'" x-cloak>

    {% set photos = meal_logs|selectattr("image_path")|list %}
    {% if photos %}
    <div class="mb-8">
        <h3 class="text-lg font-semibold mb-4">–ì–∞–ª–µ—Ä–µ—è –±–ª—é–¥ (–ü–æ—Å–ª–µ–¥–Ω–∏–µ —Ñ–æ—Ç–æ)</h3>
        <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-6 gap-4">
            {% for meal in photos[:12] %}
            <div class="group relative aspect-square bg-gray-100 rounded-lg overflow-hidden cursor-pointer border">
                <img src="{{ url_for('serve_file', filename=meal.image_path.split('/')[-1]) }}"
                     class="w-full h-full object-cover group-hover:scale-105 transition duration-300"
                     loading="lazy"
                     alt="{{ meal.name }}">
                <div class="absolute inset-0 bg-black/50 opacity-0 group-hover:opacity-100 transition flex flex-col justify-end p-2">
                    <span class="text-white text-xs font-bold truncate">{{ meal.name }}</span>
                    <span class="text-white text-xs">{{ meal.calories }} –∫–∫–∞–ª</span>
                    <span class="text-gray-300 text-[10px]">{{ meal.date.strftime('%d.%m') }}</span>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}

    <div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
        <div class="px-6 py-4 border-b bg-gray-50 flex justify-between items-center">
            <h3 class="font-semibold">–õ–æ–≥ –ø–∏—Ç–∞–Ω–∏—è</h3>
            <span class="text-xs text-gray-500">–í—Å–µ–≥–æ –∑–∞–ø–∏—Å–µ–π: {{ meal_logs|length }}</span>
        </div>
        <div class="overflow-x-auto">
          <table class="min-w-full text-sm text-left">
              <thead class="bg-gray-50 text-gray-500">
                  <tr>
                      <th class="px-6 py-3">–î–∞—Ç–∞</th>
                      <th class="px-6 py-3">–¢–∏–ø</th>
                      <th class="px-6 py-3">–ë–ª—é–¥–æ</th>
                      <th class="px-6 py-3">–ö–∫–∞–ª</th>
                      <th class="px-6 py-3">–ë/–ñ/–£</th>
                      <th class="px-6 py-3">AI –§–ª–∞–≥</th>
                  </tr>
              </thead>
              <tbody class="divide-y divide-gray-100">
                  {% for m in meal_logs %}
                  <tr class="hover:bg-gray-50">
                      <td class="px-6 py-3 whitespace-nowrap">{{ m.date.strftime('%d.%m') }}</td>
                      <td class="px-6 py-3">
                          <span class="px-2 py-1 rounded-full text-xs font-medium bg-gray-100">
                              {{ m.meal_type }}
                          </span>
                      </td>
                      <td class="px-6 py-3 font-medium text-gray-900">{{ m.name }}</td>
                      <td class="px-6 py-3">{{ m.calories }}</td>
                      <td class="px-6 py-3 text-xs text-gray-500">{{ m.protein }} / {{ m.fat }} / {{ m.carbs }}</td>
                      <td class="px-6 py-3">
                          {% if m.is_flagged %}
                              <span class="text-red-500 font-bold">‚ö†Ô∏è</span>
                          {% else %}
                              <span class="text-gray-300">‚Ä¢</span>
                          {% endif %}
                      </td>
                  </tr>
                  {% endfor %}
              </tbody>
          </table>
        </div>
    </div>
  </div>

  <div x-show="tab === 'settings'" x-cloak class="grid grid-cols-1 lg:grid-cols-2 gap-8">

      <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100">
          <h3 class="text-lg font-bold mb-6">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª—è</h3>
          <form method="post" action="{{ url_for('admin_user_edit', user_id=user.id) }}" enctype="multipart/form-data" class="space-y-4">
              <div class="grid grid-cols-2 gap-4">
                  <div>
                      <label class="block text-sm font-medium text-gray-700">–ò–º—è</label>
                      <input type="text" name="name" value="{{ user.name }}" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm border p-2">
                  </div>
                  <div>
                    <label class="block text-sm font-medium text-gray-700">–î–∞—Ç–∞ —Ä–æ–∂–¥–µ–Ω–∏—è</label>
                    <input type="date" name="date_of_birth" value="{{ user.date_of_birth.isoformat() if user.date_of_birth else '' }}" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm sm:text-sm border p-2">
                </div>
              </div>

              <div>
                  <label class="block text-sm font-medium text-gray-700">Email</label>
                  <input type="email" name="email" value="{{ user.email }}" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm sm:text-sm border p-2">
              </div>

              <div class="pt-4 border-t border-gray-100">
                  <h4 class="text-sm font-bold text-gray-900 mb-3">–¶–µ–ª–∏ –∏ –ù–æ—Ä–º—ã</h4>
                  <div class="grid grid-cols-3 gap-3">
                      <div>
                          <label class="block text-xs font-medium text-gray-500">–¶–µ–ª—å –í–µ—Å (–∫–≥)</label>
                          <input type="number" step="0.1" name="weight_goal" value="{{ user.weight_goal or '' }}" class="mt-1 w-full rounded-md border p-2 text-sm">
                      </div>
                      <div>
                          <label class="block text-xs font-medium text-gray-500">–¶–µ–ª—å –ñ–∏—Ä (–∫–≥)</label>
                          <input type="number" step="0.1" name="fat_mass_goal" value="{{ user.fat_mass_goal or '' }}" class="mt-1 w-full rounded-md border p-2 text-sm">
                      </div>
                      <div>
                          <label class="block text-xs font-medium text-gray-500">–¶–µ–ª—å –®–∞–≥–∏</label>
                          <input type="number" name="step_goal" value="{{ user.step_goal }}" class="mt-1 w-full rounded-md border p-2 text-sm">
                      </div>
                  </div>
              </div>

              <div class="pt-4 border-t border-gray-100">
                   <label class="block text-sm font-medium text-gray-700">–°–º–µ–Ω–∏—Ç—å –∞–≤–∞—Ç–∞—Ä</label>
                   <input type="file" name="avatar" class="mt-1 block w-full text-sm">
              </div>

              <div class="pt-4 border-t border-gray-100">
                  <label class="flex items-center gap-2">
                      <input type="checkbox" name="is_trainer" {% if user.is_trainer %}checked{% endif %} class="h-4 w-4 text-indigo-600 border-gray-300 rounded">
                      <span class="text-sm font-medium text-gray-700">–ü—Ä–∞–≤–∞ —Ç—Ä–µ–Ω–µ—Ä–∞</span>
                  </label>

                  <label class="flex items-center gap-2 mt-2">
                      <input type="checkbox" name="reset_onboarding" class="h-4 w-4 text-red-600 border-gray-300 rounded">
                      <span class="text-sm font-medium text-red-600">–°–±—Ä–æ—Å–∏—Ç—å —Ñ–ª–∞–≥ –ø—Ä–æ—Ö–æ–∂–¥–µ–Ω–∏—è –æ–Ω–±–æ—Ä–¥–∏–Ω–≥–∞</span>
                  </label>
              </div>

              <div class="pt-4">
                  <button type="submit" class="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700">
                      –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è
                  </button>
              </div>
          </form>
      </div>

      <div class="space-y-6">
          <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100">
              <h3 class="text-lg font-bold mb-4">Telegram Bot</h3>
              {% if user.telegram_chat_id %}
                  <div class="p-3 bg-blue-50 text-blue-800 rounded-lg text-sm mb-4">
                      –ü—Ä–∏–≤—è–∑–∞–Ω ID: <strong>{{ user.telegram_chat_id }}</strong>
                  </div>
                  <div class="flex flex-col gap-2">
                    <form method="post" action="{{ url_for('admin_user_send_test_tg', user_id=user.id) }}">
                        <button class="w-full px-4 py-2 bg-blue-600 text-white rounded text-sm hover:bg-blue-700">
                            –û—Ç–ø—Ä–∞–≤–∏—Ç—å —Ç–µ—Å—Ç
                        </button>
                    </form>
                    <button @click="unlinkOpen = true" class="w-full px-4 py-2 border border-red-200 text-red-600 rounded text-sm hover:bg-red-50">
                        –û—Ç–≤—è–∑–∞—Ç—å
                    </button>
                  </div>
              {% else %}
                  <div class="text-sm text-gray-500">–ù–µ—Ç –ø—Ä–∏–≤—è–∑–∫–∏.</div>
              {% endif %}
          </div>

          <div class="bg-white p-6 rounded-xl shadow-sm border border-red-100">
              <h3 class="text-lg font-bold text-red-600 mb-4">–û–ø–∞—Å–Ω–∞—è –∑–æ–Ω–∞</h3>
              <form action="{{ url_for('admin_delete_user', user_id=user.id) }}" method="POST"
                    onsubmit="return confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã? –£–¥–∞–ª—è—Ç—Å—è –í–°–ï –¥–∞–Ω–Ω—ã–µ (–ª–æ–≥–∏, –∞–Ω–∞–ª–∏–∑—ã, –ø–æ–¥–ø–∏—Å–∫–∏). –û—Ç–º–µ–Ω–∏—Ç—å –Ω–µ–ª—å–∑—è.');">
                  <button class="w-full px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 text-sm font-bold">
                      –£–¥–∞–ª–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–∞–≤—Å–µ–≥–¥–∞
                  </button>
              </form>
          </div>
      </div>
  </div>

  <div x-show="isSubModalOpen" x-cloak class="fixed inset-0 z-50 overflow-y-auto" aria-labelledby="modal-title" role="dialog" aria-modal="true">
    <div class="flex items-end justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
      <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity" @click="isSubModalOpen = false" aria-hidden="true"></div>
      <span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true">&#8203;</span>

      <div class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full">
        <div class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
            <h3 class="text-lg leading-6 font-medium text-gray-900">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–¥–ø–∏—Å–∫–æ–π</h3>

            <form method="post" action="{{ url_for('manage_subscription', user_id=user.id) }}" class="mt-4 space-y-4">
                <input type="hidden" name="action" value="grant">
                <div>
                    <label class="block text-sm font-medium text-gray-700">–°—Ä–æ–∫</label>
                    <div class="mt-1 grid grid-cols-3 gap-2">
                        <label class="border p-2 rounded text-center cursor-pointer hover:bg-gray-50 text-sm">
                            <input type="radio" name="duration" value="1m" class="sr-only"> 1 –º–µ—Å
                        </label>
                        <label class="border p-2 rounded text-center cursor-pointer hover:bg-gray-50 text-sm">
                            <input type="radio" name="duration" value="3m" class="sr-only"> 3 –º–µ—Å
                        </label>
                        <label class="border p-2 rounded text-center cursor-pointer hover:bg-gray-50 text-sm">
                            <input type="radio" name="duration" value="unlimited" class="sr-only"> –í–µ—á–Ω–æ
                        </label>
                    </div>
                </div>
                <div>
                     <label class="block text-sm font-medium text-gray-700">–î–∞—Ç–∞ —Å—Ç–∞—Ä—Ç–∞</label>
                     <input type="date" name="start_date" value="{{ today.isoformat() }}" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm sm:text-sm border p-2">
                </div>
                <button class="w-full bg-indigo-600 text-white py-2 rounded-md hover:bg-indigo-700">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            </form>

            <div class="border-t my-4 pt-4 flex gap-2">
                {% if user.subscription and user.subscription.is_active %}
                <form method="post" action="{{ url_for('manage_subscription', user_id=user.id) }}" class="flex-1">
                    <input type="hidden" name="action" value="freeze">
                    <button class="w-full bg-blue-100 text-blue-700 py-2 rounded hover:bg-blue-200">‚ùÑÔ∏è –ó–∞–º–æ—Ä–æ–∑–∏—Ç—å</button>
                </form>
                {% endif %}

                {% if user.subscription and user.subscription.status == 'frozen' %}
                <form method="post" action="{{ url_for('manage_subscription', user_id=user.id) }}" class="flex-1">
                    <input type="hidden" name="action" value="unfreeze">
                    <button class="w-full bg-green-100 text-green-700 py-2 rounded hover:bg-green-200">‚ñ∂Ô∏è –†–∞–∑–º–æ—Ä–æ–∑–∏—Ç—å</button>
                </form>
                {% endif %}

                {% if user.subscription %}
                <form method="post" action="{{ url_for('manage_subscription', user_id=user.id) }}" class="flex-1" onsubmit="return confirm('–£–¥–∞–ª–∏—Ç—å?');">
                    <input type="hidden" name="action" value="remove">
                    <button class="w-full bg-red-100 text-red-700 py-2 rounded hover:bg-red-200">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å</button>
                </form>
                {% endif %}
            </div>
        </div>
        <div class="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
          <button type="button" @click="isSubModalOpen = false" class="w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 sm:ml-3 sm:w-auto sm:text-sm">
            –ó–∞–∫—Ä—ã—Ç—å
          </button>
        </div>
      </div>
    </div>
  </div>

  <div x-show="unlinkOpen" x-cloak class="fixed inset-0 z-50 flex items-center justify-center p-4">
      <div class="absolute inset-0 bg-black/50" @click="unlinkOpen = false"></div>
      <div class="bg-white rounded-lg p-6 relative z-10 max-w-sm w-full">
          <h3 class="font-bold text-lg mb-2">–û—Ç–≤—è–∑–∞—Ç—å Telegram?</h3>
          <p class="text-gray-600 mb-4 text-sm">–ë–æ—Ç –ø–µ—Ä–µ—Å—Ç–∞–Ω–µ—Ç –ø—Ä–∏—Å—ã–ª–∞—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è —ç—Ç–æ–º—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é.</p>
          <div class="flex justify-end gap-2">
              <button @click="unlinkOpen = false" class="px-4 py-2 text-gray-600 hover:bg-gray-100 rounded">–û—Ç–º–µ–Ω–∞</button>
              <form method="post" action="{{ url_for('admin_user_unlink_telegram', user_id=user.id) }}">
                  <button class="px-4 py-2 bg-red-600 text-white hover:bg-red-700 rounded">–î–∞, –æ—Ç–≤—è–∑–∞—Ç—å</button>
              </form>
          </div>
      </div>
  </div>

</div>

<style>
    [x-cloak] { display: none !important; }
</style>
{% endblock %}