{% extends 'base.html' %}

{% block content %}
<div class="max-w-7xl mx-auto px-4 py-8">

    <div class="flex items-center justify-between mb-6">
        <h1 class="text-3xl font-bold text-gray-900">
            –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≥—Ä—É–ø–ø–æ–π: {{ group.name }}
            <span class="text-sm font-normal text-gray-500 ml-2">(ID: {{ group.id }})</span>
        </h1>
        <a href="{{ url_for('admin_groups_list') }}"
           class="inline-flex items-center px-4 py-2 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50">
            ‚Üê –ö —Å–ø–∏—Å–∫—É –≥—Ä—É–ø–ø
        </a>
    </div>

    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            <div class="mb-6 space-y-2">
                {% for category, message in messages %}
                    {% set color = 'red' if category == 'error' else 'green' %}
                    <div class="bg-{{ color }}-100 border-l-4 border-{{ color }}-500 text-{{ color }}-700 p-4 rounded shadow-sm">
                        {{ message }}
                    </div>
                {% endfor %}
            </div>
        {% endif %}
    {% endwith %}

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">

        <div class="lg:col-span-1 space-y-6">

            <div class="bg-white shadow rounded-lg p-6">
                <h2 class="text-lg font-medium text-gray-900 mb-4 border-b pb-2">–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –≥—Ä—É–ø–ø—ã</h2>
                <form action="{{ url_for('admin_edit_group', group_id=group.id) }}" method="POST" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700">–ù–∞–∑–≤–∞–Ω–∏–µ</label>
                        <input type="text" name="name" value="{{ group.name }}" required
                               class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm border p-2">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">–û–ø–∏—Å–∞–Ω–∏–µ</label>
                        <textarea name="description" rows="3"
                                  class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm border p-2">{{ group.description or '' }}</textarea>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">–¢—Ä–µ–Ω–µ—Ä</label>
                        <select name="trainer_id" required
                                class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm border p-2">
                            {% if group.trainer %}
                                <option value="{{ group.trainer.id }}" selected>{{ group.trainer.name }} (–¢–µ–∫—É—â–∏–π)</option>
                            {% else %}
                                <option value="" disabled selected>-- –í—ã–±–µ—Ä–∏—Ç–µ —Ç—Ä–µ–Ω–µ—Ä–∞ --</option>
                            {% endif %}
                            {% for t in trainers %}
                                {% if not group.trainer or t.id != group.trainer.id %}
                                    {% set is_busy = (t.own_group and t.own_group.id != group.id) %}
                                    <option value="{{ t.id }}" {% if is_busy %}disabled{% endif %}>
                                        {{ t.name }} {% if is_busy %}(–ó–∞–Ω—è—Ç){% endif %}
                                    </option>
                                {% endif %}
                            {% endfor %}
                        </select>
                    </div>
                    <button type="submit" class="w-full inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700">
                        –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –æ—Å–Ω–æ–≤–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
                    </button>
                </form>
            </div>

            <div class="bg-white shadow rounded-lg p-6">
                <h2 class="text-lg font-medium text-gray-900 mb-4 border-b pb-2 flex justify-between items-center">
                    –ó–∞–¥–∞—á–∏ –∏ –û–±—ä—è–≤–ª–µ–Ω–∏—è
                    <span class="bg-gray-100 text-gray-600 py-1 px-2 rounded-full text-xs">{{ group.tasks.count() }}</span>
                </h2>
                {% if group.tasks.count() > 0 %}
                    <ul class="space-y-3">
                        {% for task in group.tasks %}
                        <li class="bg-gray-50 p-3 rounded-md border border-gray-200">
                            <div class="flex justify-between items-start">
                                <div>
                                    <span class="text-xs font-bold uppercase {{ 'text-red-600' if task.is_announcement else 'text-blue-600' }}">
                                        {{ '–û–ë–™–Ø–í–õ–ï–ù–ò–ï' if task.is_announcement else '–ó–ê–î–ê–ß–ê' }}
                                    </span>
                                    <p class="text-sm font-medium text-gray-900 mt-1">{{ task.title }}</p>
                                    <p class="text-xs text-gray-500 mt-1">–î–µ–¥–ª–∞–π–Ω: {{ task.due_date if task.due_date else '–ù–µ—Ç' }}</p>
                                </div>
                                <form action="{{ url_for('delete_group_task', task_id=task.id) }}" method="POST" onsubmit="return confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç—É –∑–∞–¥–∞—á—É?');">
                                    <button type="submit" class="text-gray-400 hover:text-red-500" title="–£–¥–∞–ª–∏—Ç—å (–∫–∞–∫ –∞–¥–º–∏–Ω)">
                                        üóë
                                    </button>
                                </form>
                            </div>
                        </li>
                        {% endfor %}
                    </ul>
                {% else %}
                    <p class="text-sm text-gray-500 italic">–ê–∫—Ç–∏–≤–Ω—ã—Ö –∑–∞–¥–∞—á –Ω–µ—Ç.</p>
                {% endif %}
            </div>

        </div>

        <div class="lg:col-span-2 space-y-6">

            <div class="bg-white shadow rounded-lg p-6">
                <h2 class="text-lg font-medium text-gray-900 mb-4 border-b pb-2 flex justify-between items-center">
                    –£—á–∞—Å—Ç–Ω–∏–∫–∏
                    <span class="bg-green-100 text-green-800 py-1 px-2 rounded-full text-xs">{{ group.members|length }} —á–µ–ª.</span>
                </h2>
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</th>
                                <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Email</th>
                                <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">–î–∞—Ç–∞ –≤—Å—Ç—É–ø–ª–µ–Ω–∏—è</th>
                                <th class="px-3 py-2 text-right text-xs font-medium text-gray-500 uppercase">–ü—Ä–æ—Ñ–∏–ª—å</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-gray-200">
                            {% if group.trainer %}
                            <tr class="bg-indigo-50">
                                <td class="px-3 py-2 whitespace-nowrap">
                                    <div class="flex items-center">
                                        <div class="h-8 w-8 rounded-full bg-indigo-200 flex items-center justify-center text-indigo-700 text-xs font-bold mr-2">
                                            TR
                                        </div>
                                        <span class="text-sm font-bold text-gray-900">{{ group.trainer.name }}</span>
                                    </div>
                                </td>
                                <td class="px-3 py-2 text-sm text-gray-500">{{ group.trainer.email }}</td>
                                <td class="px-3 py-2 text-sm text-gray-500">-</td>
                                <td class="px-3 py-2 text-right text-sm">
                                    <a href="{{ url_for('admin_user_detail', user_id=group.trainer.id) }}" class="text-indigo-600 hover:text-indigo-900">–ò–Ω—Ñ–æ</a>
                                </td>
                            </tr>
                            {% endif %}

                            {% for member in group.members %}
                            <tr class="hover:bg-gray-50">
                                <td class="px-3 py-2 whitespace-nowrap">
                                    <div class="flex items-center">
                                        <div class="h-8 w-8 rounded-full bg-gray-200 flex items-center justify-center overflow-hidden mr-2">
                                            {% if member.user.avatar %}
                                                <img src="{{ url_for('serve_file', filename=member.user.avatar.filename) }}" class="h-full w-full object-cover">
                                            {% else %}
                                                <span class="text-gray-500 text-xs">{{ member.user.name[:2] }}</span>
                                            {% endif %}
                                        </div>
                                        <span class="text-sm text-gray-900">{{ member.user.name }}</span>
                                    </div>
                                </td>
                                <td class="px-3 py-2 text-sm text-gray-500">{{ member.user.email }}</td>
                                <td class="px-3 py-2 text-sm text-gray-500">{{ member.joined_at.strftime('%d.%m.%Y') }}</td>
                                <td class="px-3 py-2 text-right text-sm">
                                    <a href="{{ url_for('admin_user_detail', user_id=member.user.id) }}" class="text-blue-600 hover:text-blue-900">–ò–Ω—Ñ–æ</a>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="bg-white shadow rounded-lg p-6">
                <h2 class="text-lg font-medium text-gray-900 mb-4 border-b pb-2">
                    –ò—Å—Ç–æ—Ä–∏—è —á–∞—Ç–∞ (–ø–æ—Å–ª–µ–¥–Ω–∏–µ 50)
                </h2>

                <div class="bg-gray-50 border rounded-lg p-4 h-96 overflow-y-auto space-y-4 flex flex-col-reverse">
                    {% set messages = group.messages[-50:] %}

                    {% if messages %}
                        {% for msg in messages %}
                        <div class="flex items-start space-x-3 {{ 'justify-end' if msg.user_id == group.trainer_id else '' }}">

                            {% if msg.user_id != group.trainer_id %}
                                <div class="flex-shrink-0">
                                    <div class="h-8 w-8 rounded-full bg-gray-300 flex items-center justify-center overflow-hidden">
                                         {% if msg.user.avatar %}
                                            <img src="{{ url_for('serve_file', filename=msg.user.avatar.filename) }}" class="h-full w-full object-cover">
                                         {% else %}
                                            <span class="text-xs text-gray-600">{{ msg.user.name[:1] }}</span>
                                         {% endif %}
                                    </div>
                                </div>
                            {% endif %}

                            <div class="relative max-w-sm px-4 py-2 rounded-lg shadow-sm
                                {{ 'bg-indigo-100 text-indigo-900 rounded-br-none' if msg.user_id == group.trainer_id else 'bg-white border border-gray-200 text-gray-800 rounded-bl-none' }}">

                                <div class="flex justify-between items-baseline space-x-2 mb-1">
                                    <span class="text-xs font-bold {{ 'text-indigo-700' if msg.user_id == group.trainer_id else 'text-gray-600' }}">
                                        {{ msg.user.name }}
                                    </span>
                                    <span class="text-xs text-gray-400">{{ msg.timestamp.strftime('%d.%m %H:%M') }}</span>
                                </div>

                                {% if msg.image_file %}
                                    <div class="mb-2">
                                        <a href="{{ url_for('serve_file', filename=msg.image_file) }}" target="_blank">
                                            <img src="{{ url_for('serve_file', filename=msg.image_file) }}" class="rounded-md max-h-40 object-cover hover:opacity-90">
                                        </a>
                                    </div>
                                {% endif %}

                                <p class="text-sm whitespace-pre-wrap">{{ msg.text }}</p>

                                {% if msg.reactions %}
                                    <div class="mt-1 flex space-x-1">
                                        {% for r in msg.reactions %}
                                            <span class="text-xs bg-white/50 px-1 rounded">üëç</span>
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                        {% endfor %}
                    {% else %}
                        <p class="text-center text-gray-400 py-10">–°–æ–æ–±—â–µ–Ω–∏–π –ø–æ–∫–∞ –Ω–µ—Ç.</p>
                    {% endif %}
                </div>
            </div>

            <div class="bg-red-50 border border-red-200 rounded-lg p-6">
                <h3 class="text-lg font-medium text-red-800">–û–ø–∞—Å–Ω–∞—è –∑–æ–Ω–∞</h3>
                <p class="text-sm text-red-600 mt-1 mb-4">
                    –£–¥–∞–ª–µ–Ω–∏–µ –≥—Ä—É–ø–ø—ã –Ω–µ–æ–±—Ä–∞—Ç–∏–º–æ. –ë—É–¥—É—Ç —É–¥–∞–ª–µ–Ω—ã –≤—Å–µ —Å–æ–æ–±—â–µ–Ω–∏—è, –∏—Å—Ç–æ—Ä–∏—è –∑–∞–¥–∞—á –∏ –±–∞–ª–ª—ã —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ –≤ —ç—Ç–æ–π –≥—Ä—É–ø–ø–µ.
                </p>
                <form action="{{ url_for('admin_delete_group', group_id=group.id) }}" method="POST" onsubmit="return confirm('–í—ã –ê–ë–°–û–õ–Æ–¢–ù–û —É–≤–µ—Ä–µ–Ω—ã? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å.');">
                    <button type="submit" class="inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-red-600 hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500">
                        –£–¥–∞–ª–∏—Ç—å –≥—Ä—É–ø–ø—É –ø–æ–ª–Ω–æ—Å—Ç—å—é
                    </button>
                </form>
            </div>

        </div>
    </div>
</div>
{% endblock %}